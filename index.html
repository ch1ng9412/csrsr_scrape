<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡›æ˜Ÿå½±åƒå…ƒæ•¸æ“šè§£æèˆ‡åŒ¯å‡ºå·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS - ç‚ºäº†ç¾è§€èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter */
        html { font-family: 'Inter', sans-serif; }
        /* èª¿æ•´è¡¨æ ¼å­—é«”å¤§å°ä»¥å®¹ç´æ›´å¤šæ¬„ä½ */
        #metadata-table th, #metadata-table td {
            font-size: 0.7rem; /* ç•¥å¾®ç¸®å°å­—é«” */
        }
        /* é‡å°é»ä½åŒ¹é…è¡¨æ ¼åšä¸€äº›å„ªåŒ–ï¼Œé¿å…éåº¦æ“æ“  */
        #matched-points-table th, #matched-points-table td {
            font-size: 0.75rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        /* æ¨™ç¤ºæœªåŒ¹é…é»ä½ */
        .no-match {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            font-weight: 600;
        }
        /* æ¨™è¨˜å¤šé‡åŒ¹é… (ç¶ è‰²èƒŒæ™¯) - æ»¿è¶³ä½¿ç”¨è€…è¦æ±‚ */
        .multiple-match {
            background-color: #d1fae5; /* green-100 */
            font-weight: 600;
        }
        /* é‡å°ç¶“ç·¯åº¦æ¬„ä½å¼·åˆ¶å¢åŠ å¯¬åº¦ï¼Œç¢ºä¿å…«ä½å°æ•¸å®Œæ•´é¡¯ç¤º */
        .coordinate-cell {
            min-width: 128px; /* ç´„ 128px */
            width: 128px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <!-- æ–°å¢çš„å°è¦½åˆ‡æ›æŒ‰éˆ•å€å¡Š -->
        <div class="flex justify-end mb-4">
            <a href="app2.html" class="inline-flex items-center gap-2 px-4 py-2 bg-white hover:bg-teal-50 text-teal-700 font-semibold rounded-lg shadow-sm border border-gray-200 transition-colors text-sm">
                åˆ‡æ›è‡³ HTML è³‡æ–™æ“·å–å·¥å…·
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M5 12h14"></path>
                    <path d="M12 5l7 7-7 7"></path>
                </svg>
            </a>
        </div>

        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-teal-700">è¡›æ˜Ÿå…ƒæ•¸æ“šæ‰¹æ¬¡è§£æ</h1>
            <p class="text-gray-600 mt-2">è«‹å°‡ç¶²é å…ƒç´ ä¸­æ‰¾åˆ°çš„ <code>jQuery.data(...)</code> å­—ä¸²è²¼å…¥ä¸‹æ–¹å€åŸŸé€²è¡Œè§£æã€‚</p>
        </header>

        <!-- æ­¥é©Ÿ 1: è¼¸å…¥åŸå§‹æ•¸æ“šå€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ­¥é©Ÿ 1: è¼¸å…¥åŸå§‹å…ƒæ•¸æ“š</h2>
            
            <textarea id="raw-input" rows="8" placeholder="è«‹è²¼å…¥ä¸€ç­†æˆ–å¤šç­† jQuery.data(...) æ ¼å¼çš„å­—ä¸²"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150 font-mono text-sm"></textarea>

            <div class="flex flex-col md:flex-row gap-4 mt-4">
                 <button id="process-button"
                    class="flex-1 px-6 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-md
                           hover:bg-teal-700 transition duration-200 transform hover:scale-[1.01]">
                    <span class="mr-2">âš¡</span> è§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“š
                </button>
            </div>
            <div id="message-box" class="mt-4 p-3 rounded-lg hidden text-sm font-medium"></div>
        </div>

        <!-- æ­¥é©Ÿ 2: é»ä½åŒ¹é…å€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ­¥é©Ÿ 2: é»ä½å½±åƒåŒ¹é…åˆ†æ (ç¶“ç·¯åº¦ & æ—¥æœŸ)</h2>
            <p class="text-gray-600 mb-3 text-sm">è«‹è²¼å…¥è¦åˆ†æçš„ä¸­å¿ƒé»ä½æ•¸æ“šï¼ˆç¶“åº¦ $\text{y}$ $\rightarrow$ ç·¯åº¦ $\text{x}$ $\rightarrow$ **æ—¥æœŸ $\text{d}$**ï¼‰ï¼Œæ ¼å¼ç‚º **ç©ºæ ¼æˆ– Tab éµåˆ†éš”**ï¼Œæ¯è¡Œä¸€ç­†ã€‚æ—¥æœŸ $\text{d}$ å¿…é ˆç‚º **YYYYMMDD** æ ¼å¼ï¼ˆä¾‹å¦‚ $\text{20180807}$ï¼‰ï¼Œå°‡æœƒä¾æ“šæœˆ/æ—¥é€²è¡Œé¡å¤–åŒ¹é…ã€‚</p>
            
            <textarea id="point-input" rows="5" placeholder="ä¾‹å¦‚ï¼š&#10;121.393642 24.65833775 20180807&#10;121.2878412 24.61735664 20180423"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 font-mono text-sm"></textarea>
            
            <button id="match-button" disabled
                class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md mt-4 opacity-50 cursor-not-allowed
                       transition duration-200 hover:bg-blue-700">
                <span class="mr-2">ğŸ”</span> åŸ·è¡Œé»ä½åŒ¹é…
            </button>
            
            <p id="match-status" class="mt-4 text-sm font-medium text-gray-600">
                å·²è§£æå½±åƒï¼š<span id="record-count" class="font-mono text-teal-600">0</span> ç­†ã€‚
                å·²åŒ¹é…é»ä½ï¼š<span id="matched-count" class="font-mono text-blue-600">0</span> ç­†ã€‚
                <span id="grouped-match-info" class="text-xs text-gray-500 ml-2"></span>
            </p>

            <div id="matched-points-table-wrapper" class="overflow-x-auto rounded-lg border border-gray-200 mt-4 hidden">
                <table id="matched-points-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">é»ä½åºè™Ÿ</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider coordinate-cell">è¼¸å…¥ç¶“åº¦ (y)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider coordinate-cell">è¼¸å…¥ç·¯åº¦ (x)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¼¸å…¥æ—¥æœŸ (d)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider min-w-[200px]">åŒ¹é…ç‹€æ…‹ (IMAGE_ID)</th>
                            <!-- è§’åº¦å…ƒæ•¸æ“šæ¬„ä½ -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Incidence Angle</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Along)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Cross)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Azimuth</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Elevation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Orientation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SATELLITE</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SENSOR</th>
                        </tr>
                    </thead>
                    <tbody id="matched-points-body" class="bg-white divide-y divide-gray-200">
                        <!-- åŒ¹é…çµæœå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>

        </div>


        <!-- æ­¥é©Ÿ 3: æŸ¥è©¢çµæœèˆ‡åŒ¯å‡ºå€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ­¥é©Ÿ 3: æ•¸æ“šåŒ¯å‡ºèˆ‡å½±åƒåˆ—è¡¨</h2>

            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <button id="copy-button" disabled
                    class="flex-1 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md opacity-50 cursor-not-allowed
                           transition duration-200" title="è¤‡è£½ç•¶å‰è¡¨æ ¼æ•¸æ“š (é©ç”¨æ–¼ Excel è²¼ä¸Š)">
                    <span class="mr-2">ğŸ“‹</span> è¤‡è£½è¡¨æ ¼æ•¸æ“š
                </button>
                <button id="download-button" disabled
                    class="flex-1 px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md opacity-50 cursor-not-allowed
                           transition duration-200" title="åœ¨æœ‰æ•¸æ“šå¾Œå•Ÿç”¨">
                    <span class="mr-2">â¬‡ï¸</span> ä¸‹è¼‰è©¦ç®—è¡¨ (CSV)
                </button>
            </div>
            
            <p class="text-gray-600 mb-3 text-sm font-semibold">å·²è§£æçš„å½±åƒå…ƒæ•¸æ“šæ¸…å–®ï¼š</p>
            <div id="metadata-table-wrapper" class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="metadata-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-teal-50">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">åºè™Ÿ</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">IMAGE_ID</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SATELLITE</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SENSOR</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">ACQU_DATE (å®Œæ•´)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Incidence Angle</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Along)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Cross)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Azimuth</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Elevation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Orientation</th>
                            <!-- 8 å€‹è§’é»ç¶“ç·¯åº¦æ¬„ä½ -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿åŒ—ç·¯åº¦ (UL_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±åŒ—ç·¯åº¦ (UR_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿å—ç·¯åº¦ (LL_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±å—ç·¯åº¦ (LR_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿åŒ—ç¶“åº¦ (UL_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±åŒ—ç¶“åº¦ (UR_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿å—ç¶“åº¦ (LL_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±å—ç¶“åº¦ (LR_LNG)</th>
                            <th class="px-2 py-3 text-center font-medium text-gray-600 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="20" class="p-4 text-center text-gray-400 italic">è«‹åœ¨æ­¥é©Ÿ 1 è²¼å…¥æ•¸æ“šä¸¦é»æ“Šã€Œè§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“šã€ã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let metadataCollection = []; // å„²å­˜æ‰€æœ‰æå–åˆ°çš„å½±åƒå…ƒæ•¸æ“š
        let matchedPoints = []; // å„²å­˜åŒ¹é…æˆåŠŸçš„é»ä½æ•¸æ“š (å·²åˆ†çµ„ï¼Œä¸€è¡Œå¯èƒ½ä»£è¡¨å¤šå€‹ IMAGE_ID)

        // æ­¥é©Ÿ 1: ç²å– DOM å…ƒç´ 
        const inputArea = document.getElementById('raw-input');
        const processButton = document.getElementById('process-button');
        const downloadButton = document.getElementById('download-button');
        const copyButton = document.getElementById('copy-button');
        const messageBox = document.getElementById('message-box');
        const tableBody = document.getElementById('table-body');
        const recordCountSpan = document.getElementById('record-count');

        // æ­¥é©Ÿ 2: ç²å– DOM å…ƒç´ 
        const pointInputArea = document.getElementById('point-input');
        const matchButton = document.getElementById('match-button');
        const matchedCountSpan = document.getElementById('matched-count');
        const matchedPointsBody = document.getElementById('matched-points-body');
        const matchedPointsWrapper = document.getElementById('matched-points-table-wrapper');
        const groupedMatchInfoSpan = document.getElementById('grouped-match-info');


        // å®šç¾© CSV/TSV æ¨™é ­
        const METADATA_HEADERS = [
            'åºè™Ÿ', 'IMAGE_ID', 'SATELLITE', 'SENSOR', 'ACQU_DATE (å®Œæ•´)', 
            'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
            'Sun Azimuth', 'Sun Elevation', 'Orientation',
            'è¥¿åŒ—ç·¯åº¦ (UL_LAT)', 'æ±åŒ—ç·¯åº¦ (UR_LAT)', 'è¥¿å—ç·¯åº¦ (LL_LAT)', 'æ±å—ç·¯åº¦ (LR_LAT)',
            'è¥¿åŒ—ç¶“åº¦ (UL_LNG)', 'æ±åŒ—ç¶“åº¦ (UR_LNG)', 'è¥¿å—ç¶“åº¦ (LL_LNG)', 'æ±å—ç¶“åº¦ (LR_LNG)'
        ];

        /**
         * @description å°‡æ•¸å€¼è½‰æ›ç‚ºç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 6 ä½çš„å­—ä¸²ã€‚å¦‚æœè¼¸å…¥ç„¡æ•ˆå‰‡è¿”å› '-'ã€‚
         */
        function formatAngle(value) {
            if (value === null || value === undefined || value === '' || value === 'null' || isNaN(parseFloat(value))) {
                return '-';
            }
            return parseFloat(value).toFixed(6);
        }

        /**
         * @description å°‡ç¶“ç·¯åº¦æ•¸å€¼è½‰æ›ç‚ºç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 8 ä½çš„å­—ä¸²ã€‚å¦‚æœè¼¸å…¥ç„¡æ•ˆå‰‡è¿”å› '-'ã€‚
         */
        function formatCoordinate(value) {
            if (typeof value === 'string' && (value.includes('æœªåŒ¹é…') || value === '-')) {
                return value;
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '-';
            }
            return num.toFixed(8); // ç¢ºä¿å›ºå®š 8 ä½å°æ•¸
        }
        
        /**
         * @description å°‡ YYYYMMDD æ ¼å¼çš„æ—¥æœŸå­—ä¸²è½‰æ›ç‚º YYYY/MM/DD æ ¼å¼ç”¨æ–¼é¡¯ç¤ºæˆ–åŒ¯å‡ºã€‚
         */
        function formatDateDisplay(d) {
            if (d === '-' || (typeof d === 'string' && d.length !== 8)) return '';
            return `${d.substring(0, 4)}/${d.substring(4, 6)}/${d.substring(6, 8)}`;
        }
        
        /**
         * @description è¼”åŠ©å‡½æ•¸ - é¡¯ç¤ºè¨Šæ¯
         */
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = `mt-4 p-3 rounded-lg text-sm font-medium ${
                type === 'error' ? 'bg-red-100 text-red-800' : 
                type === 'success' ? 'bg-green-100 text-green-800' : 
                'bg-yellow-100 text-yellow-800'
            }`;
            messageBox.classList.remove('hidden');
        }

        /**
         * @description æ ¹æ“šç´¢å¼•åˆªé™¤ metadataCollection ä¸­çš„ä¸€ç­†è¨˜éŒ„ä¸¦é‡æ–°æ¸²æŸ“è¡¨æ ¼ã€‚
         */
        window.deleteRecord = function(index) {
            if (index >= 0 && index < metadataCollection.length) {
                metadataCollection.splice(index, 1);
                renderTables();
                showMessage(`å·²æˆåŠŸåˆªé™¤è¨˜éŒ„ã€‚ç›®å‰å‰©é¤˜ ${metadataCollection.length} ç­†å½±åƒæ•¸æ“šã€‚`, 'info');
            } else {
                showMessage('åˆªé™¤è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼šç„¡æ•ˆçš„ç´¢å¼•ã€‚', 'error');
            }
        }

        /**
         * @description å¾åŸå§‹å­—ä¸²ä¸­æå–å…ƒæ•¸æ“šç‰©ä»¶å­—ä¸²ã€‚
         */
        function extractDataBlocks(rawText) {
            const regex = /jQuery\.data\(body,'[^,]+',(\{.*?\})\);\s*/gs;
            const matches = [...rawText.matchAll(regex)];
            return matches.map(match => match[1]);
        }
        
        /**
         * @description å°‡å…ƒæ•¸æ“šç‰©ä»¶å­—ä¸²è½‰æ›ç‚ºçµæ§‹åŒ–çš„ JavaScript ç‰©ä»¶ã€‚
         */
        function parseDataBlock(dataString) {
            try {
                // ä½¿ç”¨ new Function ä¾†å®‰å…¨åœ°è§£æéæ¨™æº– JSON æ ¼å¼çš„æ•¸æ“šå¡Š
                const func = new Function(`return ${dataString}`);
                return func();
            } catch (e) {
                console.error("è§£ææ•¸æ“šå€å¡Šå¤±æ•—:", e, "åŸå§‹å­—ä¸²:", dataString);
                return null;
            }
        }

        // æ­¥é©Ÿ 1: ä¸»è¦è™•ç†å‡½å¼
        processButton.addEventListener('click', () => {
            const rawText = inputArea.value.trim();
            if (!rawText) {
                showMessage('è«‹åœ¨æ–‡å­—æ¡†ä¸­è²¼å…¥ jQuery.data(...) æ•¸æ“šã€‚', 'info');
                return;
            }

            const dataBlocks = extractDataBlocks(rawText);
            let processedCount = 0;
            let errorCount = 0;

            dataBlocks.forEach(block => {
                const dataObject = parseDataBlock(block);
                
                if (dataObject) {
                    const extractedData = {
                        IMAGE_ID: dataObject.IMAGE_ID || '-',
                        SATELLITE: dataObject.SATELLITE || '-',
                        SENSOR: dataObject.SENSOR || '-',
                        ACQU_DATE: dataObject.ACQU_DATE || '-',
                        // è§’åº¦æ•¸æ“š
                        Incidence_Angle: dataObject.VIEWANGLE || '-', // å…¥å°„è§’
                        View_Angle_Along: dataObject.VIEWING_ANGLE_ALONG_TRACK || '-',
                        View_Angle_Cross: dataObject.VIEWING_ANGLE_ACROSS_TRACK || '-',
                        Sun_Azimuth: dataObject.AZIMUTH || '-',
                        Sun_Elevation: dataObject.ELEVATION || '-',
                        Orientation: dataObject.ORIENTATION || '-',
                        // 8 å€‹è§’é»ç¶“ç·¯åº¦
                        UL_LAT: dataObject.UL_LAT, UR_LAT: dataObject.UR_LAT,
                        LL_LAT: dataObject.LL_LAT, LR_LAT: dataObject.LR_LAT,
                        UL_LNG: dataObject.UL_LNG, UR_LNG: dataObject.UR_LNG,
                        LL_LNG: dataObject.LL_LNG, LR_LNG: dataObject.LR_LNG,
                    };
                    metadataCollection.push(extractedData);
                    processedCount++;
                } else {
                    errorCount++;
                }
            });

            inputArea.value = '';
            renderTables();
            
            if (errorCount > 0) {
                 showMessage(`è§£æå®Œæˆã€‚æˆåŠŸæ·»åŠ  ${processedCount} ç­†å½±åƒæ•¸æ“šï¼Œæœ‰ ${errorCount} ç­†å› æ ¼å¼éŒ¯èª¤è¢«å¿½ç•¥ã€‚`, 'error');
            } else if (processedCount > 0) {
                showMessage(`è§£æå®Œæˆã€‚æˆåŠŸæ·»åŠ  ${processedCount} ç­†å½±åƒæ•¸æ“šã€‚`, 'success');
            } else {
                 showMessage('è¼¸å…¥æ¡†ä¸­æœªæª¢æ¸¬åˆ°æœ‰æ•ˆçš„å½±åƒå…ƒæ•¸æ“šã€‚', 'info');
            }
        });


        /**
         * @description åˆ¤æ–·é»ä½æ˜¯å¦è½åœ¨å½±åƒç¯„åœå…§ (åƒ…éœ€ç¶“ç·¯åº¦)ã€‚
         */
        function checkPointInImage(point, image) {
            const y = point.lng_raw; 
            const x = point.lat_raw; 

            const parseCoord = (val) => parseFloat(val) || 0;

            const UL_LAT = parseCoord(image.UL_LAT);
            const UR_LAT = parseCoord(image.UR_LAT);
            const LL_LAT = parseCoord(image.LL_LAT);
            const LR_LAT = parseCoord(image.LR_LAT);
            const UL_LNG = parseCoord(image.UL_LNG);
            const UR_LNG = parseCoord(image.UR_LNG);
            const LL_LNG = parseCoord(image.LL_LNG);
            const LR_LNG = parseCoord(image.LR_LNG);


            // 1. ç¶“åº¦åŒ…å«åœ¨å½±åƒåœ–ç•¶ä¸­ (y) 
            const minLng = Math.min(UL_LNG, UR_LNG, LL_LNG, LR_LNG);
            const maxLng = Math.max(UL_LNG, UR_LNG, LL_LNG, LR_LNG);
            
            const tolerance = 0.000001; 
            const isLngIncluded = (y >= minLng - tolerance && y <= maxLng + tolerance);
            
            if (!isLngIncluded) {
                return false;
            }

            // 2. ç·¯åº¦åŒ…å«åœ¨å½±åƒåœ–ç•¶ä¸­ (x) 
            const minLat = Math.min(UL_LAT, UR_LAT, LL_LAT, LR_LAT);
            const maxLat = Math.max(UL_LAT, UR_LAT, LL_LAT, LR_LAT);
            
            const isLatIncluded = (x >= minLat - tolerance && x <= maxLat + tolerance);
            
            if (!isLatIncluded) {
                return false;
            }

            return true;
        }

        /**
         * @description æ ¹æ“šé—œéµå…ƒæ•¸æ“šæ¬„ä½ç”Ÿæˆå”¯ä¸€éµï¼Œç”¨æ–¼è­˜åˆ¥é‡è¤‡çš„å½±åƒæ•¸æ“šã€‚
         * æ­¤éµç”¨æ–¼åˆ¤æ–·ä¸åŒ IMAGE_ID æ˜¯å¦ä»£è¡¨åŒä¸€ç­†è§’åº¦è³‡è¨Š (ä»¥åŠè¡›æ˜Ÿ/æ„Ÿæ¸¬å™¨)ã€‚
         */
        function getMatchKey(image) {
            // åŒ…å«æ‰€æœ‰è§’åº¦æ•¸æ“šã€SATELLITE å’Œ SENSOR
            return [
                image.SATELLITE,
                image.SENSOR,
                formatAngle(image.Incidence_Angle),
                formatAngle(image.View_Angle_Along),
                formatAngle(image.View_Angle_Cross),
                formatAngle(image.Sun_Azimuth),
                formatAngle(image.Sun_Elevation),
                formatAngle(image.Orientation)
            ].join('|');
        }
        
        /**
         * @description æ­¥é©Ÿ 2: åŸ·è¡Œé»ä½åŒ¹é…
         */
        matchButton.addEventListener('click', () => {
            if (metadataCollection.length === 0) {
                showMessage('è«‹å…ˆåœ¨æ­¥é©Ÿ 1 ä¸­è§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“šï¼', 'info');
                return;
            }

            const rawPoints = pointInputArea.value.trim().split('\n').filter(line => line.trim() !== '');
            if (rawPoints.length === 0) {
                showMessage('è«‹åœ¨é»ä½è¼¸å…¥æ¡†ä¸­è²¼å…¥æ•¸æ“š (ç¶“åº¦ ç·¯åº¦ [æ—¥æœŸ])ã€‚', 'info');
                return;
            }

            matchedPoints = []; // é‡ç½®åŒ¹é…çµæœ
            let totalMatchedImagesCount = 0; // ç´€éŒ„å¯¦éš›åŒ¹é…åˆ°çš„ç¸½å½±åƒç­†æ•¸
            let totalGroupedMatches = 0; // ç´€éŒ„åˆ†çµ„åˆä½µå¾Œçš„è¡Œæ•¸

            rawPoints.forEach((line, index) => {
                const parts = line.trim().split(/\s+/).filter(p => p.length > 0); 
                
                if (parts.length < 2) return; 

                const y_raw = parseFloat(parts[0].trim()); 
                const x_raw = parseFloat(parts[1].trim()); 
                
                if (isNaN(y_raw) || isNaN(x_raw)) return;

                const y_display = formatCoordinate(y_raw);
                const x_display = formatCoordinate(x_raw);
                
                const inputDateString = parts.length > 2 ? parts[2].trim().substring(0, 8) : ''; 
                const d = inputDateString.length === 8 && !isNaN(parseInt(inputDateString)) ? inputDateString : '-'; 

                const point = { 
                    lng_raw: y_raw, 
                    lat_raw: x_raw, 
                    lng_display: y_display, 
                    lat_display: x_display, 
                    originalIndex: index + 1,
                    date: d 
                };
                
                const hasDateFilter = d !== '-';
                let monthDayFilter = '';
                if (hasDateFilter) {
                    // ç²å– MM/DD æ ¼å¼ç”¨æ–¼æ¯”å°
                    monthDayFilter = d.substring(4, 6) + '/' + d.substring(6, 8); 
                }

                // å°‹æ‰¾æ‰€æœ‰åŒ¹é…çš„å½±åƒ
                const allMatches = metadataCollection.filter(image => {
                    // 1. åº§æ¨™åŒ¹é…æª¢æŸ¥ (å¿…é ˆ)
                    if (!checkPointInImage(point, image)) {
                        return false;
                    }

                    // 2. æ—¥æœŸåŒ¹é…æª¢æŸ¥ (å¦‚æœæä¾›äº†æ—¥æœŸ)
                    if (hasDateFilter) {
                        const acquDate = image.ACQU_DATE || '';
                        // ACQU_DATE æ ¼å¼ç‚º YYYY/MM/DD HH:MM:SS
                        // æª¢æŸ¥ ACQU_DATE å…§éƒ¨æ˜¯å¦åŒ…å« MM/DD
                        return acquDate.includes(monthDayFilter);
                    }

                    return true;
                });
                
                // --- è™•ç†åŒ¹é…çµæœ ---
                const numMatches = allMatches.length;

                if (numMatches === 0) {
                    // æœªåŒ¹é…ï¼šçµ±ä¸€ä½¿ç”¨ 'æœªåŒ¹é…' æ¨™ç¤º
                    matchedPoints.push({
                        index: point.originalIndex,
                        lng: point.lng_display,
                        lat: point.lat_display,
                        date: d,
                        imageIds: [], // ç©º ID åˆ—è¡¨
                        matchStatusDisplay: 'æœªåŒ¹é…',
                        matchCount: 0,
                        // é è¨­çš„ç©ºå…ƒæ•¸æ“š
                        Incidence_Angle: '-', View_Angle_Along: '-', View_Angle_Cross: '-',
                        Sun_Azimuth: '-', Sun_Elevation: '-', Orientation: '-',
                        SATELLITE: '-', SENSOR: '-'
                    });
                    totalGroupedMatches++;
                } else {
                    // åŒ¹é…æˆåŠŸ (å–®ä¸€æˆ–å¤šé‡)
                    // ä½¿ç”¨ Map é€²è¡Œåˆ†çµ„ï¼Œéµç‚ºå…ƒæ•¸æ“š Key
                    const groupedMatches = new Map();

                    allMatches.forEach(match => {
                        const key = getMatchKey(match); // ç²å–å…ƒæ•¸æ“šçš„å”¯ä¸€éµ
                        
                        // æª¢æŸ¥è©²å…ƒæ•¸æ“šçµ„æ˜¯å¦å·²å­˜åœ¨
                        if (!groupedMatches.has(key)) {
                            groupedMatches.set(key, {
                                index: point.originalIndex,
                                lng: point.lng_display,
                                lat: point.lat_display,
                                date: d,
                                imageIds: [], // å„²å­˜æ‰€æœ‰ ID
                                matchCount: 0, 
                                // å„²å­˜åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š (ç”¨æ–¼ä»£è¡¨è©²çµ„)
                                Incidence_Angle: match.Incidence_Angle,
                                View_Angle_Along: match.View_Angle_Along,
                                View_Angle_Cross: match.View_Angle_Cross,
                                Sun_Azimuth: match.Sun_Azimuth,
                                Sun_Elevation: match.Sun_Elevation,
                                Orientation: match.Orientation,
                                SATELLITE: match.SATELLITE,
                                SENSOR: match.SENSOR
                            });
                        }
                        
                        const group = groupedMatches.get(key);
                        group.imageIds.push(match.IMAGE_ID);
                        group.matchCount++;
                    });

                    // å°‡åˆ†çµ„çµæœå±•é–‹åˆ° matchedPoints åˆ—è¡¨ä¸­
                    groupedMatches.forEach(group => {
                        // æ›´æ–°é¡¯ç¤ºç‹€æ…‹ï¼šå°‡æ‰€æœ‰ ID ä»¥é€—è™Ÿåˆ†éš”
                        group.matchStatusDisplay = group.imageIds.join(', '); 
                        matchedPoints.push(group);
                        totalMatchedImagesCount += group.imageIds.length; 
                        totalGroupedMatches++;
                    });
                }
            });

            renderTables();
            // åŒ¹é…é»ä½çš„è¨ˆæ•¸ä½¿ç”¨åŸå§‹é»ä½æ•¸é‡
            const actualMatchedPointsCount = new Set(matchedPoints.filter(p => p.matchCount > 0).map(p => p.index)).size;
            
            let groupedInfoText = '';
            const successfulGroupedRows = matchedPoints.filter(p => p.matchCount > 0);
            const totalGroupedRows = successfulGroupedRows.length;
            
            if (totalMatchedImagesCount > 0) {
                 groupedInfoText = `(å…±åˆä½µç‚º ${totalGroupedRows} ç­†å…ƒæ•¸æ“šçµæœ)`;
            }

            groupedMatchInfoSpan.textContent = groupedInfoText;
            showMessage(`åŒ¹é…åˆ†æå®Œæˆã€‚å…±è™•ç† ${rawPoints.length} ç­†é»ä½ï¼ŒæˆåŠŸåŒ¹é…åˆ° ${actualMatchedPointsCount} å€‹é»ä½çš„å½±åƒæ•¸æ“š (ç¸½è¨ˆ ${totalMatchedImagesCount} ç­†å½±åƒçµæœ)ã€‚`, 'success');
        });


        // æ­¥é©Ÿ 3: æ¸²æŸ“è¡¨æ ¼ (åŒ…å«å½±åƒåˆ—è¡¨å’Œé»ä½åŒ¹é…çµæœ)
        function renderTables() {
            // --- æ¸²æŸ“å½±åƒå…ƒæ•¸æ“šè¡¨æ ¼ ---
            tableBody.innerHTML = '';
            recordCountSpan.textContent = metadataCollection.length;
            
            const hasData = metadataCollection.length > 0;
            const hasMatched = matchedPoints.length > 0;
            const colspanCount = METADATA_HEADERS.length + 1; // ç¸½æ¬„ä½æ•¸ + æ“ä½œæ¬„ (20)

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            downloadButton.disabled = !hasData && !hasMatched;
            copyButton.disabled = !hasData && !hasMatched;
            matchButton.disabled = !hasData;

            [downloadButton, copyButton, matchButton].forEach(btn => {
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:bg-green-700', 'hover:bg-blue-700');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    if (btn.id === 'download-button') btn.classList.add('hover:bg-green-700');
                    if (btn.id === 'copy-button' || btn.id === 'match-button') btn.classList.add('hover:bg-blue-700');
                }
            });


            if (!hasData) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colspanCount}" class="p-4 text-center text-gray-400 italic">è«‹åœ¨æ­¥é©Ÿ 1 è²¼å…¥æ•¸æ“šä¸¦é»æ“Šã€Œè§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“šã€ã€‚</td>
                    </tr>
                `;
            } else {
                metadataCollection.forEach((data, index) => {
                    const row = tableBody.insertRow();
                    row.classList.add('hover:bg-gray-50', 'transition', 'duration-100');
                    
                    const displayFields = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        data.ACQU_DATE,
                        formatAngle(data.Incidence_Angle), 
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        // 8 å€‹ç¶“ç·¯åº¦æ•¸æ“š
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ];

                    displayFields.forEach(value => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                        cell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700');
                        if (typeof value === 'string' && value.includes('.') && value.length > 5) {
                            cell.classList.add('font-mono', 'text-right');
                        }
                    });

                    const actionCell = row.insertCell();
                    actionCell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-center');
                    actionCell.innerHTML = `<button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-800 font-medium p-1 rounded hover:bg-red-100 transition duration-150">åˆªé™¤</button>`;
                });
            }

            // --- æ¸²æŸ“åŒ¹é…é»ä½çµæœè¡¨æ ¼ ---
            const totalPointCount = new Set(matchedPoints.map(p => p.index)).size;
            matchedCountSpan.textContent = totalPointCount;

            if (hasMatched) {
                matchedPointsWrapper.classList.remove('hidden');
                matchedPointsBody.innerHTML = '';
                
                matchedPoints.forEach((point, rowIndex) => {
                    const row = matchedPointsBody.insertRow();
                    row.classList.add('transition', 'duration-100');
                    
                    // æ¨™è¨˜å¤šé‡åŒ¹é… (matchCount > 1 è¡¨ç¤ºæ­¤è¡Œä»£è¡¨å¤šå€‹ IDï¼Œå…ƒæ•¸æ“šç›¸åŒ)
                    if (point.matchCount > 1) {
                        // ä½¿ç”¨ç¶ è‰²å¡«å……èƒŒæ™¯ (multiple-match class)
                        row.classList.add('multiple-match', 'hover:bg-green-200');
                    } else if (point.matchCount === 0) {
                        row.classList.add('no-match');
                    } else {
                        row.classList.add('hover:bg-gray-50');
                    }
                    
                    // Cells rendering logic
                    const cells = [
                        point.index,
                        point.lng, 
                        point.lat, 
                        formatDateDisplay(point.date), 
                        point.matchStatusDisplay, // é¡¯ç¤ºé€—è™Ÿåˆ†éš”çš„ IDs æˆ– 'æœªåŒ¹é…'
                        // åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š (é‡è¤‡æ•¸æ“šå·²åˆä½µç‚ºä¸€åˆ—)
                        formatAngle(point.Incidence_Angle),
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation),
                        point.SATELLITE,
                        point.SENSOR
                    ];

                    cells.forEach((value, colIndex) => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                        cell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700');
                        
                        // é‡å°è¼¸å…¥é»ä½çš„å‰å››æ¬„ (Index, Lng, Lat, Date) æ‡‰ç”¨åŸºç¤æ¨£å¼
                        if (colIndex < 4) { 
                            cell.classList.add('bg-blue-50/50', 'font-bold');
                            // å¦‚æœæ˜¯ç¶ åº•ï¼Œå‰‡è¦†è“‹é‚Šç·£æ¬„ä½çš„èƒŒæ™¯è‰²
                            if (point.matchCount > 1) {
                                cell.classList.remove('bg-blue-50/50');
                            }
                        }
                        
                        // å°ç¶“ç·¯åº¦æ•¸æ“šä½¿ç”¨ç­‰å¯¬å­—é«”ä¸¦é å³å°é½Š (ç¬¬ 1, 2 æ¬„æ˜¯ç¶“ç·¯åº¦)
                        if (colIndex === 1 || colIndex === 2) {
                            cell.classList.add('font-mono', 'text-right', 'coordinate-cell'); 
                        }
                        
                        // å°è§’åº¦æ•¸æ“šä½¿ç”¨ç­‰å¯¬å­—é«”ä¸¦é å³å°é½Š (å¾ç¬¬ 5 æ¬„åˆ°ç¬¬ 10 æ¬„æ˜¯è§’åº¦æ•¸æ“š)
                        if (colIndex >= 5 && colIndex <= 10 && typeof value === 'string' && value.includes('.') && value.length > 5) {
                             cell.classList.add('font-mono', 'text-right');
                        }
                        
                         // å°æœªåŒ¹é…çš„é»ä½
                        if (point.matchCount === 0) {
                            if (colIndex === 4) { // ç‹€æ…‹æ¬„ä½
                                cell.classList.remove('text-gray-700');
                                cell.classList.add('text-red-700', 'italic', 'font-bold');
                            } else if (colIndex > 4) { // å…ƒæ•¸æ“šæ¬„ä½ï¼Œæ¸…ç©ºå…§å®¹ä¸¦è®Šç°
                                cell.textContent = '-';
                                cell.classList.add('text-gray-400', 'italic');
                            }
                        }
                         // é‡å° ID åˆ—è¡¨æ¬„ä½ï¼Œå¼·åˆ¶æ›è¡Œé¡¯ç¤º
                        if (colIndex === 4) {
                            cell.style.whiteSpace = 'normal'; // å…è¨±è‡ªå‹•æ›è¡Œ
                            cell.style.maxWidth = '250px';
                        }
                    });
                });
            } else {
                matchedPointsWrapper.classList.add('hidden');
            }
        }


        // æ­¥é©Ÿ 3: CSV ä¸‹è¼‰é‚è¼¯
        downloadButton.addEventListener('click', downloadCSV);

        function downloadCSV() {
            if (metadataCollection.length === 0 && matchedPoints.length === 0) {
                showMessage('è¡¨æ ¼ä¸­æ²’æœ‰æ•¸æ“šå¯ä»¥ä¸‹è¼‰ã€‚', 'error');
                return;
            }

            let csv = '';

            // 1. å½±åƒå…ƒæ•¸æ“šå€å¡Š (ä¸è®Š)
            if (metadataCollection.length > 0) {
                csv += "### å½±åƒå…ƒæ•¸æ“šæ¸…å–® ###\n";
                csv += METADATA_HEADERS.join(',') + '\n';

                metadataCollection.forEach((data, index) => {
                    const rowData = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        `"${data.ACQU_DATE}"`, 
                        formatAngle(data.Incidence_Angle),
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ].join(',');
                    csv += rowData + '\n';
                });
                csv += '\n'; 
            }


            // 2. é»ä½åŒ¹é…çµæœå€å¡Š (ä½¿ç”¨åˆ†çµ„å¾Œçš„æ•¸æ“š)
            if (matchedPoints.length > 0) {
                csv += "### é»ä½åŒ¹é…çµæœ (å…ƒæ•¸æ“šç›¸åŒçš„å½±åƒå·²åˆä½µç‚ºä¸€è¡Œ) ###\n";
                
                // åŒ¯å‡ºæ¨™é ­
                const pointMatchCsvHeaders = [
                    'é»ä½åºè™Ÿ', 'è¼¸å…¥ç¶“åº¦ (y)', 'è¼¸å…¥ç·¯åº¦ (x)', 'è¼¸å…¥æ—¥æœŸ (d)', 
                    'åŒ¹é…çš„ Images_ID_List', 'åŒ¹é…æ•¸é‡ (Match Count)', 
                    'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
                    'Sun Azimuth', 'Sun Elevation', 'Orientation', 
                    'SATELLITE', 'SENSOR' // æ–°å¢çš„æ¬„ä½
                ];
                csv += pointMatchCsvHeaders.join(',') + '\n';

                matchedPoints.forEach(point => {
                    // åŒ¯å‡ºæ™‚ä½¿ç”¨åˆ†è™Ÿ (;) å€éš” IDï¼Œé¿å…é€—è™Ÿèˆ‡ CSV æ¬„ä½åˆ†éš”ç¬¦è™Ÿè¡çª
                    const imageIdList = point.matchCount === 0 ? '' : point.imageIds.join(';'); 
                    const matchCount = point.matchCount || 0;

                    const rowData = [
                        point.index,
                        point.lng, 
                        point.lat, 
                        formatDateDisplay(point.date), 
                        `"${imageIdList}"`, // è¼¸å‡º ID åˆ—è¡¨ (ç”¨å¼•è™ŸåŒ…åœï¼Œç¢ºä¿åˆ†è™Ÿä¸æœƒè¢«èª¤åˆ¤)
                        matchCount,
                        // åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š
                        formatAngle(point.Incidence_Angle),
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation),
                        point.SATELLITE || '-', // åŒ¯å‡ºè¡›æ˜Ÿ/æ„Ÿæ¸¬å™¨åç¨±
                        point.SENSOR || '-'
                    ].join(',');
                    csv += rowData + '\n';
                });
            }


            // å‰µå»º Blob ä¸¦è§¸ç™¼ä¸‹è¼‰ (ä½¿ç”¨ \ufeff ç¢ºä¿ä¸­æ–‡ç·¨ç¢¼æ­£ç¢º)
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `å½±åƒå…ƒæ•¸æ“šèˆ‡é»ä½åŒ¹é…çµæœ_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('è©¦ç®—è¡¨ä¸‹è¼‰å®Œæˆï¼', 'success');
        }


        // æ­¥é©Ÿ 3: è¤‡è£½è¡¨æ ¼æ•¸æ“šåˆ°å‰ªè²¼ç°¿ (ä½¿ç”¨ Tab åˆ†éš”)
        copyButton.addEventListener('click', copyTableToClipboard);

        function copyTableToClipboard() {
            if (metadataCollection.length === 0 && matchedPoints.length === 0) {
                showMessage('è¡¨æ ¼ä¸­æ²’æœ‰æ•¸æ“šå¯ä»¥è¤‡è£½ã€‚', 'error');
                return;
            }

            let tsv = '';

            // 1. å½±åƒå…ƒæ•¸æ“šå€å¡Š (ä¸è®Š)
            if (metadataCollection.length > 0) {
                tsv += "### å½±åƒå…ƒæ•¸æ“šæ¸…å–® ###\n";
                tsv += METADATA_HEADERS.join('\t') + '\n';

                metadataCollection.forEach((data, index) => {
                    const rowData = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        (data.ACQU_DATE || '-').replace(/\t/g, ' ').replace(/\n/g, ' '), 
                        formatAngle(data.Incidence_Angle),
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ].join('\t');
                    tsv += rowData + '\n';
                });
                tsv += '\n'; 
            }

            // 2. é»ä½åŒ¹é…çµæœå€å¡Š (ä½¿ç”¨åˆ†çµ„å¾Œçš„æ•¸æ“š)
            if (matchedPoints.length > 0) {
                tsv += "### é»ä½åŒ¹é…çµæœ (å…ƒæ•¸æ“šç›¸åŒçš„å½±åƒå·²åˆä½µç‚ºä¸€è¡Œ) ###\n";
                
                const pointMatchCsvHeaders = [
                    'é»ä½åºè™Ÿ', 'è¼¸å…¥ç¶“åº¦ (y)', 'è¼¸å…¥ç·¯åº¦ (x)', 'è¼¸å…¥æ—¥æœŸ (d)', 
                    'åŒ¹é…çš„ Images_ID_List', 'åŒ¹é…æ•¸é‡ (Match Count)', 
                    'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
                    'Sun Azimuth', 'Sun Elevation', 'Orientation',
                    'SATELLITE', 'SENSOR' // æ–°å¢çš„æ¬„ä½
                ];
                tsv += pointMatchCsvHeaders.join('\t') + '\n';

                matchedPoints.forEach(point => {
                    // åŒ¯å‡ºæ™‚ä½¿ç”¨åˆ†è™Ÿ (;) å€éš” IDï¼Œé€™æ˜¯ Excel è²¼ä¸Šæ™‚æœ€ä¸å®¹æ˜“å‡ºéŒ¯çš„åˆ†éš”æ–¹å¼
                    const imageIdList = point.matchCount === 0 ? '' : point.imageIds.join(';'); 
                    const matchCount = point.matchCount || 0;

                    const rowData = [
                        point.index,
                        point.lng, 
                        point.lat, 
                        formatDateDisplay(point.date), 
                        imageIdList, // TSV ä¸­ç›´æ¥è¼¸å‡º ID åˆ—è¡¨
                        matchCount,
                        // åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š
                        formatAngle(point.Incidence_Angle),
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation),
                        point.SATELLITE || '-',
                        point.SENSOR || '-'
                    ].join('\t');
                    tsv += rowData + '\n';
                });
            }


            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = tsv;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('è¡¨æ ¼æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹åˆ‡æ›åˆ° Excel è²¼ä¸Š (Ctrl+V)ã€‚', 'success');
                } else {
                    showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–æ‰‹å‹•è¤‡è£½ã€‚', 'error');
                }
            } catch (err) {
                console.error('åŸ·è¡Œè¤‡è£½å‘½ä»¤å¤±æ•—:', err);
                showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–æ‰‹å‹•è¤‡è£½ã€‚', 'error');
            }
            
            document.body.removeChild(tempTextArea);
        }

        // åˆå§‹åŒ–æ™‚æ¸²æŸ“ç©ºè¡¨æ ¼
        renderTables();

    </script>
</body>
</html>
