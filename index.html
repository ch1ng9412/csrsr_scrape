<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¡›æ˜Ÿå½±åƒå…ƒæ•¸æ“šè§£æèˆ‡åŒ¯å‡ºå·¥å…·</title>
    <!-- è¼‰å…¥ Tailwind CSS - ç‚ºäº†ç¾è§€èˆ‡éŸ¿æ‡‰å¼è¨­è¨ˆ -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* è¨­å®šå­—é«”ç‚º Inter */
        html { font-family: 'Inter', sans-serif; }
        /* èª¿æ•´è¡¨æ ¼å­—é«”å¤§å°ä»¥å®¹ç´æ›´å¤šæ¬„ä½ */
        #metadata-table th, #metadata-table td {
            font-size: 0.7rem; /* ç•¥å¾®ç¸®å°å­—é«” */
        }
        /* é‡å°é»ä½åŒ¹é…è¡¨æ ¼åšä¸€äº›å„ªåŒ–ï¼Œé¿å…éåº¦æ“æ“  */
        #matched-points-table th, #matched-points-table td {
            font-size: 0.75rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-teal-700">è¡›æ˜Ÿå…ƒæ•¸æ“šæ‰¹æ¬¡è§£æ</h1>
            <p class="text-gray-600 mt-2">è«‹å°‡ç¶²é å…ƒç´ ä¸­æ‰¾åˆ°çš„ <code>jQuery.data(...)</code> å­—ä¸²è²¼å…¥ä¸‹æ–¹å€åŸŸé€²è¡Œè§£æã€‚</p>
        </header>

        <!-- æ­¥é©Ÿ 1: è¼¸å…¥åŸå§‹æ•¸æ“šå€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ­¥é©Ÿ 1: è¼¸å…¥åŸå§‹å…ƒæ•¸æ“š</h2>
            
            <textarea id="raw-input" rows="8" placeholder="è«‹è²¼å…¥ä¸€ç­†æˆ–å¤šç­† jQuery.data(...) æ ¼å¼çš„å­—ä¸²"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150 font-mono text-sm"></textarea>

            <div class="flex flex-col md:flex-row gap-4 mt-4">
                 <button id="process-button"
                    class="flex-1 px-6 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-md
                           hover:bg-teal-700 transition duration-200 transform hover:scale-[1.01]">
                    <span class="mr-2">âš¡</span> è§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“š
                </button>
            </div>
            <div id="message-box" class="mt-4 p-3 rounded-lg hidden text-sm font-medium"></div>
        </div>

        <!-- æ­¥é©Ÿ 2: é»ä½åŒ¹é…å€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ­¥é©Ÿ 2: é»ä½å½±åƒåŒ¹é…åˆ†æ (ç¶“ç·¯åº¦ & æ—¥æœŸ)</h2>
            <p class="text-gray-600 mb-3 text-sm">è«‹è²¼å…¥è¦åˆ†æçš„ä¸­å¿ƒé»ä½æ•¸æ“šï¼ˆç¶“åº¦ $\text{y}$ $\rightarrow$ ç·¯åº¦ $\text{x}$ $\rightarrow$ **æ—¥æœŸ $\text{d}$**ï¼‰ï¼Œæ ¼å¼ç‚º **ç©ºæ ¼æˆ– Tab éµåˆ†éš”**ï¼Œæ¯è¡Œä¸€ç­†ã€‚æ—¥æœŸ $\text{d}$ å¿…é ˆç‚º **YYYYMMDD** æ ¼å¼ï¼ˆä¾‹å¦‚ $\text{20180807}$ï¼‰ï¼Œå°‡æœƒä¾æ“šæœˆ/æ—¥é€²è¡Œé¡å¤–åŒ¹é…ã€‚</p>
            
            <textarea id="point-input" rows="5" placeholder="ä¾‹å¦‚ï¼š&#10;121.393642 24.65833775 20180807&#10;121.2878412 24.61735664 20180423"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 font-mono text-sm"></textarea>
            
            <button id="match-button" disabled
                class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md mt-4 opacity-50 cursor-not-allowed
                       transition duration-200 hover:bg-blue-700">
                <span class="mr-2">ğŸ”</span> åŸ·è¡Œé»ä½åŒ¹é…
            </button>
            
            <p id="match-status" class="mt-4 text-sm font-medium text-gray-600">
                å·²è§£æå½±åƒï¼š<span id="record-count" class="font-mono text-teal-600">0</span> ç­†ã€‚
                å·²åŒ¹é…é»ä½ï¼š<span id="matched-count" class="font-mono text-blue-600">0</span> ç­†ã€‚
            </p>

            <div id="matched-points-table-wrapper" class="overflow-x-auto rounded-lg border border-gray-200 mt-4 hidden">
                <table id="matched-points-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">é»ä½åºè™Ÿ</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¼¸å…¥ç¶“åº¦ (y)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¼¸å…¥ç·¯åº¦ (x)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¼¸å…¥æ—¥æœŸ (d)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">åŒ¹é…çš„ IMAGE_ID</th>
                            <!-- æ–°å¢ Incidnece Angle æ¬„ä½ -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Incidence Angle</th>
                            <!-- å…¶ä»–å…ƒæ•¸æ“šæ¬„ä½ -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Along)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Cross)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Azimuth</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Elevation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Orientation</th>
                        </tr>
                    </thead>
                    <tbody id="matched-points-body" class="bg-white divide-y divide-gray-200">
                        <!-- åŒ¹é…çµæœå°‡åœ¨æ­¤è™•æ¸²æŸ“ -->
                    </tbody>
                </table>
            </div>

        </div>


        <!-- æ­¥é©Ÿ 3: æŸ¥è©¢çµæœèˆ‡åŒ¯å‡ºå€å¡Š -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">æ­¥é©Ÿ 3: æ•¸æ“šåŒ¯å‡ºèˆ‡å½±åƒåˆ—è¡¨</h2>

            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <button id="copy-button" disabled
                    class="flex-1 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md opacity-50 cursor-not-allowed
                           transition duration-200" title="è¤‡è£½ç•¶å‰è¡¨æ ¼æ•¸æ“š (é©ç”¨æ–¼ Excel è²¼ä¸Š)">
                    <span class="mr-2">ğŸ“‹</span> è¤‡è£½è¡¨æ ¼æ•¸æ“š
                </button>
                <button id="download-button" disabled
                    class="flex-1 px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md opacity-50 cursor-not-allowed
                           transition duration-200" title="åœ¨æœ‰æ•¸æ“šå¾Œå•Ÿç”¨">
                    <span class="mr-2">â¬‡ï¸</span> ä¸‹è¼‰è©¦ç®—è¡¨ (CSV)
                </button>
            </div>
            
            <p class="text-gray-600 mb-3 text-sm font-semibold">å·²è§£æçš„å½±åƒå…ƒæ•¸æ“šæ¸…å–®ï¼š</p>
            <div id="metadata-table-wrapper" class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="metadata-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-teal-50">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">åºè™Ÿ</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">IMAGE_ID</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SATELLITE</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SENSOR</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">ACQU_DATE (å®Œæ•´)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Incidence Angle</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Along)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Cross)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Azimuth</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Elevation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Orientation</th>
                            <!-- 8 å€‹è§’é»ç¶“ç·¯åº¦æ¬„ä½ -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿åŒ—ç·¯åº¦ (UL_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±åŒ—ç·¯åº¦ (UR_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿å—ç·¯åº¦ (LL_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±å—ç·¯åº¦ (LR_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿åŒ—ç¶“åº¦ (UL_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±åŒ—ç¶“åº¦ (UR_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">è¥¿å—ç¶“åº¦ (LL_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">æ±å—ç¶“åº¦ (LR_LNG)</th>
                            <th class="px-2 py-3 text-center font-medium text-gray-600 uppercase tracking-wider">æ“ä½œ</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="20" class="p-4 text-center text-gray-400 italic">è«‹åœ¨æ­¥é©Ÿ 1 è²¼å…¥æ•¸æ“šä¸¦é»æ“Šã€Œè§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“šã€ã€‚</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // å…¨åŸŸè®Šæ•¸
        let metadataCollection = []; // å„²å­˜æ‰€æœ‰æå–åˆ°çš„å½±åƒå…ƒæ•¸æ“š
        let matchedPoints = []; // å„²å­˜åŒ¹é…æˆåŠŸçš„é»ä½æ•¸æ“š

        // æ­¥é©Ÿ 1: ç²å– DOM å…ƒç´ 
        const inputArea = document.getElementById('raw-input');
        const processButton = document.getElementById('process-button');
        const downloadButton = document.getElementById('download-button');
        const copyButton = document.getElementById('copy-button');
        const messageBox = document.getElementById('message-box');
        const tableBody = document.getElementById('table-body');
        const recordCountSpan = document.getElementById('record-count');

        // æ­¥é©Ÿ 2: ç²å– DOM å…ƒç´ 
        const pointInputArea = document.getElementById('point-input');
        const matchButton = document.getElementById('match-button');
        const matchedCountSpan = document.getElementById('matched-count');
        const matchedPointsBody = document.getElementById('matched-points-body');
        const matchedPointsWrapper = document.getElementById('matched-points-table-wrapper');


        // å®šç¾© CSV/TSV æ¨™é ­
        const METADATA_HEADERS = [
            'åºè™Ÿ', 'IMAGE_ID', 'SATELLITE', 'SENSOR', 'ACQU_DATE (å®Œæ•´)', 
            'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
            'Sun Azimuth', 'Sun Elevation', 'Orientation',
            'è¥¿åŒ—ç·¯åº¦ (UL_LAT)', 'æ±åŒ—ç·¯åº¦ (UR_LAT)', 'è¥¿å—ç·¯åº¦ (LL_LAT)', 'æ±å—ç·¯åº¦ (LR_LAT)',
            'è¥¿åŒ—ç¶“åº¦ (UL_LNG)', 'æ±åŒ—ç¶“åº¦ (UR_LNG)', 'è¥¿å—ç¶“åº¦ (LL_LNG)', 'æ±å—ç¶“åº¦ (LR_LNG)'
        ];

        // åŒ¹é…çµæœè¡¨æ ¼çš„æ¨™é ­ (åŒ…å«æ—¥æœŸå’Œæ–°å¢çš„å…­å€‹è§’åº¦/æ–¹ä½æ¬„ä½)
        const POINT_MATCH_HEADERS = [
            'é»ä½åºè™Ÿ', 'è¼¸å…¥ç¶“åº¦ (y)', 'è¼¸å…¥ç·¯åº¦ (x)', 'è¼¸å…¥æ—¥æœŸ (d)', 'åŒ¹é…çš„ IMAGE_ID',
            'Incidence Angle', // æ–°å¢
            'View Angle(Along)', 'View Angle(Cross)', 'Sun Azimuth', 'Sun Elevation', 'Orientation'
        ];

        /**
         * @description å°‡æ•¸å€¼è½‰æ›ç‚ºç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 6 ä½çš„å­—ä¸²ã€‚å¦‚æœè¼¸å…¥ç„¡æ•ˆå‰‡è¿”å› '-'ã€‚
         */
        function formatAngle(value) {
            if (value === null || value === undefined || value === '' || value === 'null' || isNaN(parseFloat(value))) {
                return '-';
            }
            return parseFloat(value).toFixed(6);
        }

        /**
         * @description å°‡ç¶“ç·¯åº¦æ•¸å€¼è½‰æ›ç‚ºç²¾ç¢ºåˆ°å°æ•¸é»å¾Œ 8 ä½çš„å­—ä¸²ã€‚å¦‚æœè¼¸å…¥ç„¡æ•ˆå‰‡è¿”å› '-'ã€‚
         */
        function formatCoordinate(value) {
            if (value === null || value === undefined || value === '' || value === 'null' || isNaN(parseFloat(value))) {
                return '-';
            }
            return parseFloat(value).toFixed(8);
        }
        
        /**
         * @description è¼”åŠ©å‡½æ•¸ - é¡¯ç¤ºè¨Šæ¯
         */
        function showMessage(text, type = 'info') {
            // å¿½ç•¥å…·é«”å¯¦ç¾ï¼Œç¢ºä¿è¨Šæ¯é¡¯ç¤º
            messageBox.textContent = text;
            messageBox.className = `mt-4 p-3 rounded-lg text-sm font-medium ${
                type === 'error' ? 'bg-red-100 text-red-800' : 
                type === 'success' ? 'bg-green-100 text-green-800' : 
                'bg-yellow-100 text-yellow-800'
            }`;
            messageBox.classList.remove('hidden');
        }

        /**
         * @description æ ¹æ“šç´¢å¼•åˆªé™¤ metadataCollection ä¸­çš„ä¸€ç­†è¨˜éŒ„ä¸¦é‡æ–°æ¸²æŸ“è¡¨æ ¼ã€‚
         */
        window.deleteRecord = function(index) {
            if (index >= 0 && index < metadataCollection.length) {
                metadataCollection.splice(index, 1);
                renderTables();
                showMessage(`å·²æˆåŠŸåˆªé™¤è¨˜éŒ„ã€‚ç›®å‰å‰©é¤˜ ${metadataCollection.length} ç­†å½±åƒæ•¸æ“šã€‚`, 'info');
            } else {
                showMessage('åˆªé™¤è¨˜éŒ„æ™‚ç™¼ç”ŸéŒ¯èª¤ï¼šç„¡æ•ˆçš„ç´¢å¼•ã€‚', 'error');
            }
        }

        /**
         * @description å¾åŸå§‹å­—ä¸²ä¸­æå–å…ƒæ•¸æ“šç‰©ä»¶å­—ä¸²ã€‚
         */
        function extractDataBlocks(rawText) {
            const regex = /jQuery\.data\(body,'[^,]+',(\{.*?\})\);\s*/gs;
            const matches = [...rawText.matchAll(regex)];
            return matches.map(match => match[1]);
        }
        
        /**
         * @description å°‡å…ƒæ•¸æ“šç‰©ä»¶å­—ä¸²è½‰æ›ç‚ºçµæ§‹åŒ–çš„ JavaScript ç‰©ä»¶ã€‚
         */
        function parseDataBlock(dataString) {
            try {
                // ä½¿ç”¨ new Function ä¾†å®‰å…¨åœ°è§£æéæ¨™æº– JSON æ ¼å¼çš„æ•¸æ“šå¡Š
                const func = new Function(`return ${dataString}`);
                return func();
            } catch (e) {
                console.error("è§£ææ•¸æ“šå€å¡Šå¤±æ•—:", e, "åŸå§‹å­—ä¸²:", dataString);
                return null;
            }
        }

        // æ­¥é©Ÿ 1: ä¸»è¦è™•ç†å‡½å¼
        processButton.addEventListener('click', () => {
            const rawText = inputArea.value.trim();
            if (!rawText) {
                showMessage('è«‹åœ¨æ–‡å­—æ¡†ä¸­è²¼å…¥ jQuery.data(...) æ•¸æ“šã€‚', 'info');
                return;
            }

            const dataBlocks = extractDataBlocks(rawText);
            let processedCount = 0;
            let errorCount = 0;

            dataBlocks.forEach(block => {
                const dataObject = parseDataBlock(block);
                
                if (dataObject) {
                    const extractedData = {
                        IMAGE_ID: dataObject.IMAGE_ID || '-',
                        SATELLITE: dataObject.SATELLITE || '-',
                        SENSOR: dataObject.SENSOR || '-',
                        ACQU_DATE: dataObject.ACQU_DATE || '-',
                        // è§’åº¦æ•¸æ“š
                        Incidence_Angle: dataObject.VIEWANGLE || '-', // å…¥å°„è§’
                        View_Angle_Along: dataObject.VIEWING_ANGLE_ALONG_TRACK || '-',
                        View_Angle_Cross: dataObject.VIEWING_ANGLE_ACROSS_TRACK || '-',
                        Sun_Azimuth: dataObject.AZIMUTH || '-',
                        Sun_Elevation: dataObject.ELEVATION || '-',
                        Orientation: dataObject.ORIENTATION || '-',
                        // 8 å€‹è§’é»ç¶“ç·¯åº¦
                        UL_LAT: dataObject.UL_LAT, UR_LAT: dataObject.UR_LAT,
                        LL_LAT: dataObject.LL_LAT, LR_LAT: dataObject.LR_LAT,
                        UL_LNG: dataObject.UL_LNG, UR_LNG: dataObject.UR_LNG,
                        LL_LNG: dataObject.LL_LNG, LR_LNG: dataObject.LR_LNG,
                    };
                    metadataCollection.push(extractedData);
                    processedCount++;
                } else {
                    errorCount++;
                }
            });

            inputArea.value = '';
            renderTables();
            
            if (errorCount > 0) {
                 showMessage(`è§£æå®Œæˆã€‚æˆåŠŸæ·»åŠ  ${processedCount} ç­†å½±åƒæ•¸æ“šï¼Œæœ‰ ${errorCount} ç­†å› æ ¼å¼éŒ¯èª¤è¢«å¿½ç•¥ã€‚`, 'error');
            } else if (processedCount > 0) {
                showMessage(`è§£æå®Œæˆã€‚æˆåŠŸæ·»åŠ  ${processedCount} ç­†å½±åƒæ•¸æ“šã€‚`, 'success');
            } else {
                 showMessage('è¼¸å…¥æ¡†ä¸­æœªæª¢æ¸¬åˆ°æœ‰æ•ˆçš„å½±åƒå…ƒæ•¸æ“šã€‚', 'info');
            }
        });


        /**
         * @description åˆ¤æ–·é»ä½æ˜¯å¦è½åœ¨å½±åƒç¯„åœå…§ (åƒ…éœ€ç¶“ç·¯åº¦)ã€‚
         * @param {object} point {lng: y, lat: x}
         * @param {object} image å½±åƒå…ƒæ•¸æ“š
         * @returns {boolean}
         */
        function checkPointInImage(point, image) {
            const y = point.lng; // ä¸­å¿ƒç¶“åº¦
            const x = point.lat; // ä¸­å¿ƒç·¯åº¦

            // è¼”åŠ©å‡½æ•¸ï¼šå®‰å…¨è§£ææ•¸å€¼
            const parseCoord = (val) => parseFloat(val) || 0;

            const UL_LAT = parseCoord(image.UL_LAT);
            const UR_LAT = parseCoord(image.UR_LAT);
            const LL_LAT = parseCoord(image.LL_LAT);
            const LR_LAT = parseCoord(image.LR_LAT);
            const UL_LNG = parseCoord(image.UL_LNG);
            const UR_LNG = parseCoord(image.UR_LNG);
            const LL_LNG = parseCoord(image.LL_LNG);
            const LR_LNG = parseCoord(image.LR_LNG);


            // 1. ç¶“åº¦åŒ…å«åœ¨å½±åƒåœ–ç•¶ä¸­ (y) 
            // ç”±æ–¼è§’é»ç¶“ç·¯åº¦å¯èƒ½ç¨å¾®è®Šå‹•ï¼Œä½¿ç”¨è¿‘ä¼¼çš„é‚Šç•Œåˆ¤æ–·
            const minLng = Math.min(UL_LNG, UR_LNG, LL_LNG, LR_LNG);
            const maxLng = Math.max(UL_LNG, UR_LNG, LL_LNG, LR_LNG);
            
            const isLngIncluded = (y >= minLng && y <= maxLng);
            
            if (!isLngIncluded) {
                return false;
            }

            // 2. ç·¯åº¦åŒ…å«åœ¨å½±åƒåœ–ç•¶ä¸­ (x) 
            const minLat = Math.min(UL_LAT, UR_LAT, LL_LAT, LR_LAT);
            const maxLat = Math.max(UL_LAT, UR_LAT, LL_LAT, LR_LAT);
            
            const isLatIncluded = (x >= minLat && x <= maxLat);
            
            if (!isLatIncluded) {
                return false;
            }

            // æ»¿è¶³æ‰€æœ‰æ¢ä»¶ (ç¶“ç·¯åº¦æ¢ä»¶)
            return true;
        }
        
        /**
         * @description æ­¥é©Ÿ 2: åŸ·è¡Œé»ä½åŒ¹é…
         */
        matchButton.addEventListener('click', () => {
            if (metadataCollection.length === 0) {
                showMessage('è«‹å…ˆåœ¨æ­¥é©Ÿ 1 ä¸­è§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“šï¼', 'info');
                return;
            }

            // æ¥å— ç¶“åº¦ ç·¯åº¦ [æ—¥æœŸ]ï¼Œä½¿ç”¨ä¸€å€‹æˆ–å¤šå€‹ç©ºæ ¼/Tabéµä½œç‚ºåˆ†éš”ç¬¦
            const rawPoints = pointInputArea.value.trim().split('\n').filter(line => line.trim() !== '');
            if (rawPoints.length === 0) {
                showMessage('è«‹åœ¨é»ä½è¼¸å…¥æ¡†ä¸­è²¼å…¥æ•¸æ“š (ç¶“åº¦ ç·¯åº¦ [æ—¥æœŸ])ã€‚', 'info');
                return;
            }

            matchedPoints = []; // é‡ç½®åŒ¹é…çµæœ

            rawPoints.forEach((line, index) => {
                // ä½¿ç”¨ /\s+/ æ­£å‰‡è¡¨é”å¼ä¾†åˆ†éš”ç©ºæ ¼æˆ– Tab
                const parts = line.trim().split(/\s+/).filter(p => p.length > 0); 
                
                // å¿…é ˆè‡³å°‘æœ‰ 2 å€‹éƒ¨åˆ† (ç¶“åº¦, ç·¯åº¦)
                if (parts.length < 2) return; 

                const y = parseFloat(parts[0].trim()); // ä¸­å¿ƒç¶“åº¦ (y)
                const x = parseFloat(parts[1].trim()); // ä¸­å¿ƒç·¯åº¦ (x)
                
                // å¦‚æœä½¿ç”¨è€…è¼¸å…¥äº†ç¬¬ä¸‰å€‹æ—¥æœŸæ¬„ä½ï¼Œæˆ‘å€‘å°‡å®ƒä½œç‚º YYYYMMDD æ ¼å¼è™•ç†
                const inputDateString = parts.length > 2 ? parts[2].trim().substring(0, 8) : ''; 
                const d = inputDateString.length === 8 ? inputDateString : '-'; // ç¢ºä¿æ˜¯ YYYYMMDD æˆ– '-'

                if (isNaN(y) || isNaN(x)) return;

                const point = { lng: y, lat: x, originalIndex: index + 1 };
                let matchedImageId = 'æœªåŒ¹é…';
                
                // è¨­å®šæ—¥æœŸéæ¿¾å™¨
                const hasDateFilter = d !== '-';
                let monthDayFilter = '';
                if (hasDateFilter) {
                    // å°‡ YYYYMMDD è½‰æ›ç‚º MM/DD (e.g., '08/07')
                    monthDayFilter = d.substring(4, 6) + '/' + d.substring(6, 8); 
                }

                // åˆå§‹åŒ–åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š
                let matchedMetadata = { 
                    Incidence_Angle: '-', // æ–°å¢
                    View_Angle_Along: '-',
                    View_Angle_Cross: '-',
                    Sun_Azimuth: '-',
                    Sun_Elevation: '-',
                    Orientation: '-'
                };

                // å°‹æ‰¾åŒ¹é…çš„å½±åƒ (åŒæ™‚æª¢æŸ¥åº§æ¨™å’Œæ—¥æœŸ)
                const match = metadataCollection.find(image => {
                    // 1. åº§æ¨™åŒ¹é…æª¢æŸ¥ (å¿…é ˆ)
                    if (!checkPointInImage(point, image)) {
                        return false;
                    }

                    // 2. æ—¥æœŸåŒ¹é…æª¢æŸ¥ (å¦‚æœæä¾›äº†æ—¥æœŸ)
                    if (hasDateFilter) {
                        const acquDate = image.ACQU_DATE || '';
                        // æª¢æŸ¥ ACQU_DATE (e.g., '2018/08/07 10:30:00') æ˜¯å¦åŒ…å« '08/07'
                        // ACQU_DATE æ ¼å¼æ‡‰ç‚º YYYY/MM/DD HH:MM:SS
                        return acquDate.includes(monthDayFilter);
                    }

                    // å¦‚æœæ²’æœ‰æä¾›æ—¥æœŸï¼Œåªè¦åº§æ¨™åŒ¹é…å°±è¦–ç‚ºæˆåŠŸ
                    return true;
                });

                if (match) {
                    matchedImageId = match.IMAGE_ID;
                    // å¦‚æœåŒ¹é…æˆåŠŸï¼Œæå–é¡å¤–çš„å…ƒæ•¸æ“š
                    matchedMetadata = {
                        Incidence_Angle: match.Incidence_Angle, // æ–°å¢
                        View_Angle_Along: match.View_Angle_Along,
                        View_Angle_Cross: match.View_Angle_Cross,
                        Sun_Azimuth: match.Sun_Azimuth,
                        Sun_Elevation: match.Sun_Elevation,
                        Orientation: match.Orientation
                    };
                }

                // å°‡é»ä½èˆ‡åŒ¹é…åˆ°çš„å…ƒæ•¸æ“šä¸€èµ·å„²å­˜
                matchedPoints.push({
                    index: point.originalIndex,
                    lng: formatCoordinate(y),
                    lat: formatCoordinate(x),
                    date: d, // å„²å­˜ YYYYMMDD æ ¼å¼æˆ– '-'
                    imageId: matchedImageId,
                    ...matchedMetadata // å±•é–‹åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š (æˆ–é è¨­çš„ '-')
                });
            });

            renderTables();
            showMessage(`åŒ¹é…åˆ†æå®Œæˆã€‚å…±è™•ç† ${rawPoints.length} ç­†é»ä½ï¼ŒæˆåŠŸåŒ¹é… ${matchedPoints.filter(p => p.imageId !== 'æœªåŒ¹é…').length} ç­†ã€‚`, 'success');
        });


        // æ­¥é©Ÿ 3: æ¸²æŸ“è¡¨æ ¼ (åŒ…å«å½±åƒåˆ—è¡¨å’Œé»ä½åŒ¹é…çµæœ)
        function renderTables() {
            // --- æ¸²æŸ“å½±åƒå…ƒæ•¸æ“šè¡¨æ ¼ ---
            tableBody.innerHTML = '';
            recordCountSpan.textContent = metadataCollection.length;
            
            const hasData = metadataCollection.length > 0;
            const hasMatched = matchedPoints.length > 0;
            const colspanCount = METADATA_HEADERS.length + 1; // ç¸½æ¬„ä½æ•¸ + æ“ä½œæ¬„ (20)

            // æ›´æ–°æŒ‰éˆ•ç‹€æ…‹
            downloadButton.disabled = !hasData && !hasMatched;
            copyButton.disabled = !hasData && !hasMatched;
            matchButton.disabled = !hasData;

            [downloadButton, copyButton, matchButton].forEach(btn => {
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:bg-green-700', 'hover:bg-blue-700');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    if (btn.id === 'download-button') btn.classList.add('hover:bg-green-700');
                    if (btn.id === 'copy-button' || btn.id === 'match-button') btn.classList.add('hover:bg-blue-700');
                }
            });


            if (!hasData) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colspanCount}" class="p-4 text-center text-gray-400 italic">è«‹åœ¨æ­¥é©Ÿ 1 è²¼å…¥æ•¸æ“šä¸¦é»æ“Šã€Œè§£æä¸¦æ·»åŠ å½±åƒæ•¸æ“šã€ã€‚</td>
                    </tr>
                `;
            } else {
                metadataCollection.forEach((data, index) => {
                    const row = tableBody.insertRow();
                    row.classList.add('hover:bg-gray-50', 'transition', 'duration-100');
                    
                    const displayFields = [
                        index + 1, // åºè™Ÿ
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        data.ACQU_DATE,
                        formatAngle(data.Incidence_Angle), // å…¥å°„è§’
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        // 8 å€‹ç¶“ç·¯åº¦æ•¸æ“š
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ];

                    displayFields.forEach(value => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                        cell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700');
                        if (typeof value === 'string' && value.includes('.')) {
                            cell.classList.add('font-mono', 'text-right');
                        }
                    });

                    const actionCell = row.insertCell();
                    actionCell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-center');
                    actionCell.innerHTML = `<button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-800 font-medium p-1 rounded hover:bg-red-100 transition duration-150">åˆªé™¤</button>`;
                });
            }

            // --- æ¸²æŸ“åŒ¹é…é»ä½çµæœè¡¨æ ¼ ---
            matchedCountSpan.textContent = matchedPoints.length;

            if (hasMatched) {
                matchedPointsWrapper.classList.remove('hidden');
                matchedPointsBody.innerHTML = '';
                matchedPoints.forEach((point) => {
                    const row = matchedPointsBody.insertRow();
                    row.classList.add('hover:bg-gray-50', 'transition', 'duration-100');
                    
                    // æ³¨æ„ï¼šé€™è£¡çš„ cells é †åºèˆ‡ POINT_MATCH_HEADERS åŒ¹é…
                    const cells = [
                        point.index,
                        point.lng,
                        point.lat,
                        point.date === '-' ? '' : point.date, // è¼¸å‡º YYYYMMDD
                        point.imageId,
                        // æ–°å¢çš„åŒ¹é…å…ƒæ•¸æ“š
                        formatAngle(point.Incidence_Angle), // å…¥å°„è§’
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation)
                    ];

                    cells.forEach((value) => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                        cell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700');
                        
                        // å°æœªåŒ¹é…çš„é»ä½æ¨™è¨˜é¡è‰²
                        if (point.imageId === 'æœªåŒ¹é…' && cells.indexOf(value) <= 4) { // åªå°å‰äº”æ¬„æ¨™è¨˜
                             cell.classList.add('text-red-500', 'italic', 'font-semibold');
                        }
                        
                        // å°è§’åº¦æ•¸æ“šä½¿ç”¨ç­‰å¯¬å­—é«”ä¸¦é å³å°é½Š
                        if (typeof value === 'string' && value.includes('.') && value.length > 5) {
                             cell.classList.add('font-mono', 'text-right');
                        }
                    });
                });
            } else {
                matchedPointsWrapper.classList.add('hidden');
            }
        }


        // æ­¥é©Ÿ 3: CSV ä¸‹è¼‰é‚è¼¯
        downloadButton.addEventListener('click', downloadCSV);

        function downloadCSV() {
            if (metadataCollection.length === 0 && matchedPoints.length === 0) {
                showMessage('è¡¨æ ¼ä¸­æ²’æœ‰æ•¸æ“šå¯ä»¥ä¸‹è¼‰ã€‚', 'error');
                return;
            }

            let csv = '';

            // 1. å½±åƒå…ƒæ•¸æ“šå€å¡Š
            if (metadataCollection.length > 0) {
                csv += "### å½±åƒå…ƒæ•¸æ“šæ¸…å–® ###\n";
                csv += METADATA_HEADERS.join(',') + '\n';

                metadataCollection.forEach((data, index) => {
                    const rowData = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        `"${data.ACQU_DATE}"`, // ç¢ºä¿æ—¥æœŸåŒ…å«å¼•è™Ÿ
                        formatAngle(data.Incidence_Angle), // å…¥å°„è§’
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ].join(',');
                    csv += rowData + '\n';
                });
                csv += '\n'; // åˆ†éš”ç¬¦
            }


            // 2. é»ä½åŒ¹é…çµæœå€å¡Š
            if (matchedPoints.length > 0) {
                csv += "### é»ä½åŒ¹é…çµæœ ###\n";
                // åŒ¯å‡ºæ™‚åŒ…å«æ—¥æœŸæ¬„ä½
                csv += POINT_MATCH_HEADERS.join(',') + '\n';

                matchedPoints.forEach(point => {
                    const rowData = [
                        point.index,
                        point.lng,
                        point.lat,
                        point.date === '-' ? '' : point.date, // è¼¸å‡º YYYYMMDD
                        point.imageId,
                        // åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š
                        formatAngle(point.Incidence_Angle), // å…¥å°„è§’
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation)
                    ].join(',');
                    csv += rowData + '\n';
                });
            }


            // å‰µå»º Blob ä¸¦è§¸ç™¼ä¸‹è¼‰ (ä½¿ç”¨ \ufeff ç¢ºä¿ä¸­æ–‡ç·¨ç¢¼æ­£ç¢º)
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `å½±åƒå…ƒæ•¸æ“šèˆ‡é»ä½åŒ¹é…çµæœ_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('è©¦ç®—è¡¨ä¸‹è¼‰å®Œæˆï¼', 'success');
        }


        // æ­¥é©Ÿ 3: è¤‡è£½è¡¨æ ¼æ•¸æ“šåˆ°å‰ªè²¼ç°¿ (ä½¿ç”¨ Tab åˆ†éš”)
        copyButton.addEventListener('click', copyTableToClipboard);

        function copyTableToClipboard() {
            if (metadataCollection.length === 0 && matchedPoints.length === 0) {
                showMessage('è¡¨æ ¼ä¸­æ²’æœ‰æ•¸æ“šå¯ä»¥è¤‡è£½ã€‚', 'error');
                return;
            }

            let tsv = '';

            // 1. å½±åƒå…ƒæ•¸æ“šå€å¡Š (TSV)
            if (metadataCollection.length > 0) {
                tsv += "### å½±åƒå…ƒæ•¸æ“šæ¸…å–® ###\n";
                tsv += METADATA_HEADERS.join('\t') + '\n';

                metadataCollection.forEach((data, index) => {
                    const rowData = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        (data.ACQU_DATE || '-').replace(/\t/g, ' ').replace(/\n/g, ' '), 
                        formatAngle(data.Incidence_Angle), // å…¥å°„è§’
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ].join('\t');
                    tsv += rowData + '\n';
                });
                tsv += '\n'; // åˆ†éš”ç¬¦
            }

            // 2. é»ä½åŒ¹é…çµæœå€å¡Š (TSV)
            if (matchedPoints.length > 0) {
                tsv += "### é»ä½åŒ¹é…çµæœ ###\n";
                // åŒ¯å‡ºæ™‚åŒ…å«æ—¥æœŸæ¬„ä½
                tsv += POINT_MATCH_HEADERS.join('\t') + '\n';

                matchedPoints.forEach(point => {
                    const rowData = [
                        point.index,
                        point.lng,
                        point.lat,
                        point.date === '-' ? '' : point.date, // è¼¸å‡º YYYYMMDD
                        point.imageId,
                        // åŒ¹é…åˆ°çš„å…ƒæ•¸æ“š
                        formatAngle(point.Incidence_Angle), // å…¥å°„è§’
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation)
                    ].join('\t');
                    tsv += rowData + '\n';
                });
            }


            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = tsv;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('è¡¨æ ¼æ•¸æ“šå·²æˆåŠŸè¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼è«‹åˆ‡æ›åˆ° Excel è²¼ä¸Š (Ctrl+V)ã€‚', 'success');
                } else {
                    showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–æ‰‹å‹•è¤‡è£½ã€‚', 'error');
                }
            } catch (err) {
                console.error('åŸ·è¡Œè¤‡è£½å‘½ä»¤å¤±æ•—:', err);
                showMessage('è¤‡è£½å¤±æ•—ï¼Œè«‹æª¢æŸ¥ç€è¦½å™¨æ¬Šé™æˆ–æ‰‹å‹•è¤‡è£½ã€‚', 'error');
            }
            
            document.body.removeChild(tempTextArea);
        }

        // åˆå§‹åŒ–æ™‚æ¸²æŸ“ç©ºè¡¨æ ¼
        renderTables();

    </script>
</body>
</html>
