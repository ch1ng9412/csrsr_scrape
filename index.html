<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>衛星影像元數據解析與匯出工具</title>
    <!-- 載入 Tailwind CSS - 為了美觀與響應式設計 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定字體為 Inter */
        html { font-family: 'Inter', sans-serif; }
        /* 調整表格字體大小以容納更多欄位 */
        #metadata-table th, #metadata-table td {
            font-size: 0.7rem; /* 略微縮小字體 */
        }
        /* 針對點位匹配表格做一些優化，避免過度擁擠 */
        #matched-points-table th, #matched-points-table td {
            font-size: 0.75rem;
            padding-left: 0.5rem;
            padding-right: 0.5rem;
        }
        /* 標示未匹配點位 */
        .no-match {
            background-color: #fee2e2; /* red-100 */
            color: #b91c1c; /* red-700 */
            font-weight: 600;
        }
        /* 標記多重匹配 (綠色背景) - 滿足使用者要求 */
        .multiple-match {
            background-color: #d1fae5; /* green-100 */
            font-weight: 600;
        }
        /* 針對經緯度欄位強制增加寬度，確保八位小數完整顯示 */
        .coordinate-cell {
            min-width: 128px; /* 約 128px */
            width: 128px;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen p-4 md:p-8">

    <div id="app" class="max-w-7xl mx-auto">
        <header class="mb-8 text-center">
            <h1 class="text-4xl font-extrabold text-teal-700">衛星元數據批次解析</h1>
            <p class="text-gray-600 mt-2">請將網頁元素中找到的 <code>jQuery.data(...)</code> 字串貼入下方區域進行解析。</p>
        </header>

        <!-- 步驟 1: 輸入原始數據區塊 -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 1: 輸入原始元數據</h2>
            
            <textarea id="raw-input" rows="8" placeholder="請貼入一筆或多筆 jQuery.data(...) 格式的字串"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-teal-500 focus:border-teal-500 transition duration-150 font-mono text-sm"></textarea>

            <div class="flex flex-col md:flex-row gap-4 mt-4">
                 <button id="process-button"
                    class="flex-1 px-6 py-3 bg-teal-600 text-white font-bold rounded-lg shadow-md
                           hover:bg-teal-700 transition duration-200 transform hover:scale-[1.01]">
                    <span class="mr-2">⚡</span> 解析並添加影像數據
                </button>
            </div>
            <div id="message-box" class="mt-4 p-3 rounded-lg hidden text-sm font-medium"></div>
        </div>

        <!-- 步驟 2: 點位匹配區塊 -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100 mb-8">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 2: 點位影像匹配分析 (經緯度 & 日期)</h2>
            <p class="text-gray-600 mb-3 text-sm">請貼入要分析的中心點位數據（經度 $\text{y}$ $\rightarrow$ 緯度 $\text{x}$ $\rightarrow$ **日期 $\text{d}$**），格式為 **空格或 Tab 鍵分隔**，每行一筆。日期 $\text{d}$ 必須為 **YYYYMMDD** 格式（例如 $\text{20180807}$），將會依據月/日進行額外匹配。</p>
            
            <textarea id="point-input" rows="5" placeholder="例如：&#10;121.393642 24.65833775 20180807&#10;121.2878412 24.61735664 20180423"
                      class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500 transition duration-150 font-mono text-sm"></textarea>
            
            <button id="match-button" disabled
                class="w-full px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md mt-4 opacity-50 cursor-not-allowed
                       transition duration-200 hover:bg-blue-700">
                <span class="mr-2">🔎</span> 執行點位匹配
            </button>
            
            <p id="match-status" class="mt-4 text-sm font-medium text-gray-600">
                已解析影像：<span id="record-count" class="font-mono text-teal-600">0</span> 筆。
                已匹配點位：<span id="matched-count" class="font-mono text-blue-600">0</span> 筆。
                <span id="grouped-match-info" class="text-xs text-gray-500 ml-2"></span>
            </p>

            <div id="matched-points-table-wrapper" class="overflow-x-auto rounded-lg border border-gray-200 mt-4 hidden">
                <table id="matched-points-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-blue-50">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">點位序號</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider coordinate-cell">輸入經度 (y)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider coordinate-cell">輸入緯度 (x)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">輸入日期 (d)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider min-w-[200px]">匹配狀態 (IMAGE_ID)</th>
                            <!-- 角度元數據欄位 -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Incidence Angle</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Along)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Cross)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Azimuth</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Elevation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Orientation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SATELLITE</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SENSOR</th>
                        </tr>
                    </thead>
                    <tbody id="matched-points-body" class="bg-white divide-y divide-gray-200">
                        <!-- 匹配結果將在此處渲染 -->
                    </tbody>
                </table>
            </div>

        </div>


        <!-- 步驟 3: 查詢結果與匯出區塊 -->
        <div class="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">步驟 3: 數據匯出與影像列表</h2>

            <div class="flex flex-col md:flex-row gap-4 mb-4">
                <button id="copy-button" disabled
                    class="flex-1 px-6 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-md opacity-50 cursor-not-allowed
                           transition duration-200" title="複製當前表格數據 (適用於 Excel 貼上)">
                    <span class="mr-2">📋</span> 複製表格數據
                </button>
                <button id="download-button" disabled
                    class="flex-1 px-6 py-3 bg-green-500 text-white font-bold rounded-lg shadow-md opacity-50 cursor-not-allowed
                           transition duration-200" title="在有數據後啟用">
                    <span class="mr-2">⬇️</span> 下載試算表 (CSV)
                </button>
            </div>
            
            <p class="text-gray-600 mb-3 text-sm font-semibold">已解析的影像元數據清單：</p>
            <div id="metadata-table-wrapper" class="overflow-x-auto rounded-lg border border-gray-200">
                <table id="metadata-table" class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-teal-50">
                        <tr>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">序號</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">IMAGE_ID</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SATELLITE</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">SENSOR</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">ACQU_DATE (完整)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Incidence Angle</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Along)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">View Angle(Cross)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Azimuth</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Sun Elevation</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">Orientation</th>
                            <!-- 8 個角點經緯度欄位 -->
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">西北緯度 (UL_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">東北緯度 (UR_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">西南緯度 (LL_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">東南緯度 (LR_LAT)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">西北經度 (UL_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">東北經度 (UR_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">西南經度 (LL_LNG)</th>
                            <th class="px-2 py-3 text-left font-medium text-gray-600 uppercase tracking-wider">東南經度 (LR_LNG)</th>
                            <th class="px-2 py-3 text-center font-medium text-gray-600 uppercase tracking-wider">操作</th>
                        </tr>
                    </thead>
                    <tbody id="table-body" class="bg-white divide-y divide-gray-200">
                        <tr>
                            <td colspan="20" class="p-4 text-center text-gray-400 italic">請在步驟 1 貼入數據並點擊「解析並添加影像數據」。</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // 全域變數
        let metadataCollection = []; // 儲存所有提取到的影像元數據
        let matchedPoints = []; // 儲存匹配成功的點位數據 (已分組，一行可能代表多個 IMAGE_ID)

        // 步驟 1: 獲取 DOM 元素
        const inputArea = document.getElementById('raw-input');
        const processButton = document.getElementById('process-button');
        const downloadButton = document.getElementById('download-button');
        const copyButton = document.getElementById('copy-button');
        const messageBox = document.getElementById('message-box');
        const tableBody = document.getElementById('table-body');
        const recordCountSpan = document.getElementById('record-count');

        // 步驟 2: 獲取 DOM 元素
        const pointInputArea = document.getElementById('point-input');
        const matchButton = document.getElementById('match-button');
        const matchedCountSpan = document.getElementById('matched-count');
        const matchedPointsBody = document.getElementById('matched-points-body');
        const matchedPointsWrapper = document.getElementById('matched-points-table-wrapper');
        const groupedMatchInfoSpan = document.getElementById('grouped-match-info');


        // 定義 CSV/TSV 標頭
        const METADATA_HEADERS = [
            '序號', 'IMAGE_ID', 'SATELLITE', 'SENSOR', 'ACQU_DATE (完整)', 
            'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
            'Sun Azimuth', 'Sun Elevation', 'Orientation',
            '西北緯度 (UL_LAT)', '東北緯度 (UR_LAT)', '西南緯度 (LL_LAT)', '東南緯度 (LR_LAT)',
            '西北經度 (UL_LNG)', '東北經度 (UR_LNG)', '西南經度 (LL_LNG)', '東南經度 (LR_LNG)'
        ];

        /**
         * @description 將數值轉換為精確到小數點後 6 位的字串。如果輸入無效則返回 '-'。
         */
        function formatAngle(value) {
            if (value === null || value === undefined || value === '' || value === 'null' || isNaN(parseFloat(value))) {
                return '-';
            }
            return parseFloat(value).toFixed(6);
        }

        /**
         * @description 將經緯度數值轉換為精確到小數點後 8 位的字串。如果輸入無效則返回 '-'。
         */
        function formatCoordinate(value) {
            if (typeof value === 'string' && (value.includes('未匹配') || value === '-')) {
                return value;
            }
            const num = parseFloat(value);
            if (isNaN(num)) {
                return '-';
            }
            return num.toFixed(8); // 確保固定 8 位小數
        }
        
        /**
         * @description 將 YYYYMMDD 格式的日期字串轉換為 YYYY/MM/DD 格式用於顯示或匯出。
         */
        function formatDateDisplay(d) {
            if (d === '-' || (typeof d === 'string' && d.length !== 8)) return '';
            return `${d.substring(0, 4)}/${d.substring(4, 6)}/${d.substring(6, 8)}`;
        }
        
        /**
         * @description 輔助函數 - 顯示訊息
         */
        function showMessage(text, type = 'info') {
            messageBox.textContent = text;
            messageBox.className = `mt-4 p-3 rounded-lg text-sm font-medium ${
                type === 'error' ? 'bg-red-100 text-red-800' : 
                type === 'success' ? 'bg-green-100 text-green-800' : 
                'bg-yellow-100 text-yellow-800'
            }`;
            messageBox.classList.remove('hidden');
        }

        /**
         * @description 根據索引刪除 metadataCollection 中的一筆記錄並重新渲染表格。
         */
        window.deleteRecord = function(index) {
            if (index >= 0 && index < metadataCollection.length) {
                metadataCollection.splice(index, 1);
                renderTables();
                showMessage(`已成功刪除記錄。目前剩餘 ${metadataCollection.length} 筆影像數據。`, 'info');
            } else {
                showMessage('刪除記錄時發生錯誤：無效的索引。', 'error');
            }
        }

        /**
         * @description 從原始字串中提取元數據物件字串。
         */
        function extractDataBlocks(rawText) {
            const regex = /jQuery\.data\(body,'[^,]+',(\{.*?\})\);\s*/gs;
            const matches = [...rawText.matchAll(regex)];
            return matches.map(match => match[1]);
        }
        
        /**
         * @description 將元數據物件字串轉換為結構化的 JavaScript 物件。
         */
        function parseDataBlock(dataString) {
            try {
                // 使用 new Function 來安全地解析非標準 JSON 格式的數據塊
                const func = new Function(`return ${dataString}`);
                return func();
            } catch (e) {
                console.error("解析數據區塊失敗:", e, "原始字串:", dataString);
                return null;
            }
        }

        // 步驟 1: 主要處理函式
        processButton.addEventListener('click', () => {
            const rawText = inputArea.value.trim();
            if (!rawText) {
                showMessage('請在文字框中貼入 jQuery.data(...) 數據。', 'info');
                return;
            }

            const dataBlocks = extractDataBlocks(rawText);
            let processedCount = 0;
            let errorCount = 0;

            dataBlocks.forEach(block => {
                const dataObject = parseDataBlock(block);
                
                if (dataObject) {
                    const extractedData = {
                        IMAGE_ID: dataObject.IMAGE_ID || '-',
                        SATELLITE: dataObject.SATELLITE || '-',
                        SENSOR: dataObject.SENSOR || '-',
                        ACQU_DATE: dataObject.ACQU_DATE || '-',
                        // 角度數據
                        Incidence_Angle: dataObject.VIEWANGLE || '-', // 入射角
                        View_Angle_Along: dataObject.VIEWING_ANGLE_ALONG_TRACK || '-',
                        View_Angle_Cross: dataObject.VIEWING_ANGLE_ACROSS_TRACK || '-',
                        Sun_Azimuth: dataObject.AZIMUTH || '-',
                        Sun_Elevation: dataObject.ELEVATION || '-',
                        Orientation: dataObject.ORIENTATION || '-',
                        // 8 個角點經緯度
                        UL_LAT: dataObject.UL_LAT, UR_LAT: dataObject.UR_LAT,
                        LL_LAT: dataObject.LL_LAT, LR_LAT: dataObject.LR_LAT,
                        UL_LNG: dataObject.UL_LNG, UR_LNG: dataObject.UR_LNG,
                        LL_LNG: dataObject.LL_LNG, LR_LNG: dataObject.LR_LNG,
                    };
                    metadataCollection.push(extractedData);
                    processedCount++;
                } else {
                    errorCount++;
                }
            });

            inputArea.value = '';
            renderTables();
            
            if (errorCount > 0) {
                 showMessage(`解析完成。成功添加 ${processedCount} 筆影像數據，有 ${errorCount} 筆因格式錯誤被忽略。`, 'error');
            } else if (processedCount > 0) {
                showMessage(`解析完成。成功添加 ${processedCount} 筆影像數據。`, 'success');
            } else {
                 showMessage('輸入框中未檢測到有效的影像元數據。', 'info');
            }
        });


        /**
         * @description 判斷點位是否落在影像範圍內 (僅需經緯度)。
         */
        function checkPointInImage(point, image) {
            const y = point.lng_raw; 
            const x = point.lat_raw; 

            const parseCoord = (val) => parseFloat(val) || 0;

            const UL_LAT = parseCoord(image.UL_LAT);
            const UR_LAT = parseCoord(image.UR_LAT);
            const LL_LAT = parseCoord(image.LL_LAT);
            const LR_LAT = parseCoord(image.LR_LAT);
            const UL_LNG = parseCoord(image.UL_LNG);
            const UR_LNG = parseCoord(image.UR_LNG);
            const LL_LNG = parseCoord(image.LL_LNG);
            const LR_LNG = parseCoord(image.LR_LNG);


            // 1. 經度包含在影像圖當中 (y) 
            const minLng = Math.min(UL_LNG, UR_LNG, LL_LNG, LR_LNG);
            const maxLng = Math.max(UL_LNG, UR_LNG, LL_LNG, LR_LNG);
            
            const tolerance = 0.000001; 
            const isLngIncluded = (y >= minLng - tolerance && y <= maxLng + tolerance);
            
            if (!isLngIncluded) {
                return false;
            }

            // 2. 緯度包含在影像圖當中 (x) 
            const minLat = Math.min(UL_LAT, UR_LAT, LL_LAT, LR_LAT);
            const maxLat = Math.max(UL_LAT, UR_LAT, LL_LAT, LR_LAT);
            
            const isLatIncluded = (x >= minLat - tolerance && x <= maxLat + tolerance);
            
            if (!isLatIncluded) {
                return false;
            }

            return true;
        }

        /**
         * @description 根據關鍵元數據欄位生成唯一鍵，用於識別重複的影像數據。
         * 此鍵用於判斷不同 IMAGE_ID 是否代表同一筆角度資訊 (以及衛星/感測器)。
         */
        function getMatchKey(image) {
            // 包含所有角度數據、SATELLITE 和 SENSOR
            return [
                image.SATELLITE,
                image.SENSOR,
                formatAngle(image.Incidence_Angle),
                formatAngle(image.View_Angle_Along),
                formatAngle(image.View_Angle_Cross),
                formatAngle(image.Sun_Azimuth),
                formatAngle(image.Sun_Elevation),
                formatAngle(image.Orientation)
            ].join('|');
        }
        
        /**
         * @description 步驟 2: 執行點位匹配
         */
        matchButton.addEventListener('click', () => {
            if (metadataCollection.length === 0) {
                showMessage('請先在步驟 1 中解析並添加影像數據！', 'info');
                return;
            }

            const rawPoints = pointInputArea.value.trim().split('\n').filter(line => line.trim() !== '');
            if (rawPoints.length === 0) {
                showMessage('請在點位輸入框中貼入數據 (經度 緯度 [日期])。', 'info');
                return;
            }

            matchedPoints = []; // 重置匹配結果
            let totalMatchedImagesCount = 0; // 紀錄實際匹配到的總影像筆數
            let totalGroupedMatches = 0; // 紀錄分組合併後的行數

            rawPoints.forEach((line, index) => {
                const parts = line.trim().split(/\s+/).filter(p => p.length > 0); 
                
                if (parts.length < 2) return; 

                const y_raw = parseFloat(parts[0].trim()); 
                const x_raw = parseFloat(parts[1].trim()); 
                
                if (isNaN(y_raw) || isNaN(x_raw)) return;

                const y_display = formatCoordinate(y_raw);
                const x_display = formatCoordinate(x_raw);
                
                const inputDateString = parts.length > 2 ? parts[2].trim().substring(0, 8) : ''; 
                const d = inputDateString.length === 8 && !isNaN(parseInt(inputDateString)) ? inputDateString : '-'; 

                const point = { 
                    lng_raw: y_raw, 
                    lat_raw: x_raw, 
                    lng_display: y_display, 
                    lat_display: x_display, 
                    originalIndex: index + 1,
                    date: d 
                };
                
                const hasDateFilter = d !== '-';
                let monthDayFilter = '';
                if (hasDateFilter) {
                    // 獲取 MM/DD 格式用於比對
                    monthDayFilter = d.substring(4, 6) + '/' + d.substring(6, 8); 
                }

                // 尋找所有匹配的影像
                const allMatches = metadataCollection.filter(image => {
                    // 1. 座標匹配檢查 (必須)
                    if (!checkPointInImage(point, image)) {
                        return false;
                    }

                    // 2. 日期匹配檢查 (如果提供了日期)
                    if (hasDateFilter) {
                        const acquDate = image.ACQU_DATE || '';
                        // ACQU_DATE 格式為 YYYY/MM/DD HH:MM:SS
                        // 檢查 ACQU_DATE 內部是否包含 MM/DD
                        return acquDate.includes(monthDayFilter);
                    }

                    return true;
                });
                
                // --- 處理匹配結果 ---
                const numMatches = allMatches.length;

                if (numMatches === 0) {
                    // 未匹配：統一使用 '未匹配' 標示
                    matchedPoints.push({
                        index: point.originalIndex,
                        lng: point.lng_display,
                        lat: point.lat_display,
                        date: d,
                        imageIds: [], // 空 ID 列表
                        matchStatusDisplay: '未匹配',
                        matchCount: 0,
                        // 預設的空元數據
                        Incidence_Angle: '-', View_Angle_Along: '-', View_Angle_Cross: '-',
                        Sun_Azimuth: '-', Sun_Elevation: '-', Orientation: '-',
                        SATELLITE: '-', SENSOR: '-'
                    });
                    totalGroupedMatches++;
                } else {
                    // 匹配成功 (單一或多重)
                    // 使用 Map 進行分組，鍵為元數據 Key
                    const groupedMatches = new Map();

                    allMatches.forEach(match => {
                        const key = getMatchKey(match); // 獲取元數據的唯一鍵
                        
                        // 檢查該元數據組是否已存在
                        if (!groupedMatches.has(key)) {
                            groupedMatches.set(key, {
                                index: point.originalIndex,
                                lng: point.lng_display,
                                lat: point.lat_display,
                                date: d,
                                imageIds: [], // 儲存所有 ID
                                matchCount: 0, 
                                // 儲存匹配到的元數據 (用於代表該組)
                                Incidence_Angle: match.Incidence_Angle,
                                View_Angle_Along: match.View_Angle_Along,
                                View_Angle_Cross: match.View_Angle_Cross,
                                Sun_Azimuth: match.Sun_Azimuth,
                                Sun_Elevation: match.Sun_Elevation,
                                Orientation: match.Orientation,
                                SATELLITE: match.SATELLITE,
                                SENSOR: match.SENSOR
                            });
                        }
                        
                        const group = groupedMatches.get(key);
                        group.imageIds.push(match.IMAGE_ID);
                        group.matchCount++;
                    });

                    // 將分組結果展開到 matchedPoints 列表中
                    groupedMatches.forEach(group => {
                        // 更新顯示狀態：將所有 ID 以逗號分隔
                        group.matchStatusDisplay = group.imageIds.join(', '); 
                        matchedPoints.push(group);
                        totalMatchedImagesCount += group.imageIds.length; 
                        totalGroupedMatches++;
                    });
                }
            });

            renderTables();
            // 匹配點位的計數使用原始點位數量
            const actualMatchedPointsCount = new Set(matchedPoints.filter(p => p.matchCount > 0).map(p => p.index)).size;
            
            let groupedInfoText = '';
            const successfulGroupedRows = matchedPoints.filter(p => p.matchCount > 0);
            const totalGroupedRows = successfulGroupedRows.length;
            
            if (totalMatchedImagesCount > 0) {
                 groupedInfoText = `(共合併為 ${totalGroupedRows} 筆元數據結果)`;
            }

            groupedMatchInfoSpan.textContent = groupedInfoText;
            showMessage(`匹配分析完成。共處理 ${rawPoints.length} 筆點位，成功匹配到 ${actualMatchedPointsCount} 個點位的影像數據 (總計 ${totalMatchedImagesCount} 筆影像結果)。`, 'success');
        });


        // 步驟 3: 渲染表格 (包含影像列表和點位匹配結果)
        function renderTables() {
            // --- 渲染影像元數據表格 ---
            tableBody.innerHTML = '';
            recordCountSpan.textContent = metadataCollection.length;
            
            const hasData = metadataCollection.length > 0;
            const hasMatched = matchedPoints.length > 0;
            const colspanCount = METADATA_HEADERS.length + 1; // 總欄位數 + 操作欄 (20)

            // 更新按鈕狀態
            downloadButton.disabled = !hasData && !hasMatched;
            copyButton.disabled = !hasData && !hasMatched;
            matchButton.disabled = !hasData;

            [downloadButton, copyButton, matchButton].forEach(btn => {
                if (btn.disabled) {
                    btn.classList.add('opacity-50', 'cursor-not-allowed');
                    btn.classList.remove('hover:bg-green-700', 'hover:bg-blue-700');
                } else {
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                    if (btn.id === 'download-button') btn.classList.add('hover:bg-green-700');
                    if (btn.id === 'copy-button' || btn.id === 'match-button') btn.classList.add('hover:bg-blue-700');
                }
            });


            if (!hasData) {
                tableBody.innerHTML = `
                    <tr>
                        <td colspan="${colspanCount}" class="p-4 text-center text-gray-400 italic">請在步驟 1 貼入數據並點擊「解析並添加影像數據」。</td>
                    </tr>
                `;
            } else {
                metadataCollection.forEach((data, index) => {
                    const row = tableBody.insertRow();
                    row.classList.add('hover:bg-gray-50', 'transition', 'duration-100');
                    
                    const displayFields = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        data.ACQU_DATE,
                        formatAngle(data.Incidence_Angle), 
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        // 8 個經緯度數據
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ];

                    displayFields.forEach(value => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                        cell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700');
                        if (typeof value === 'string' && value.includes('.') && value.length > 5) {
                            cell.classList.add('font-mono', 'text-right');
                        }
                    });

                    const actionCell = row.insertCell();
                    actionCell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-center');
                    actionCell.innerHTML = `<button onclick="deleteRecord(${index})" class="text-red-600 hover:text-red-800 font-medium p-1 rounded hover:bg-red-100 transition duration-150">刪除</button>`;
                });
            }

            // --- 渲染匹配點位結果表格 ---
            const totalPointCount = new Set(matchedPoints.map(p => p.index)).size;
            matchedCountSpan.textContent = totalPointCount;

            if (hasMatched) {
                matchedPointsWrapper.classList.remove('hidden');
                matchedPointsBody.innerHTML = '';
                
                matchedPoints.forEach((point, rowIndex) => {
                    const row = matchedPointsBody.insertRow();
                    row.classList.add('transition', 'duration-100');
                    
                    // 標記多重匹配 (matchCount > 1 表示此行代表多個 ID，元數據相同)
                    if (point.matchCount > 1) {
                        // 使用綠色填充背景 (multiple-match class)
                        row.classList.add('multiple-match', 'hover:bg-green-200');
                    } else if (point.matchCount === 0) {
                        row.classList.add('no-match');
                    } else {
                        row.classList.add('hover:bg-gray-50');
                    }
                    
                    // Cells rendering logic
                    const cells = [
                        point.index,
                        point.lng, 
                        point.lat, 
                        formatDateDisplay(point.date), 
                        point.matchStatusDisplay, // 顯示逗號分隔的 IDs 或 '未匹配'
                        // 匹配到的元數據 (重複數據已合併為一列)
                        formatAngle(point.Incidence_Angle),
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation),
                        point.SATELLITE,
                        point.SENSOR
                    ];

                    cells.forEach((value, colIndex) => {
                        const cell = row.insertCell();
                        cell.textContent = value;
                        cell.classList.add('px-2', 'py-2', 'whitespace-nowrap', 'text-sm', 'text-gray-700');
                        
                        // 針對輸入點位的前四欄 (Index, Lng, Lat, Date) 應用基礎樣式
                        if (colIndex < 4) { 
                            cell.classList.add('bg-blue-50/50', 'font-bold');
                            // 如果是綠底，則覆蓋邊緣欄位的背景色
                            if (point.matchCount > 1) {
                                cell.classList.remove('bg-blue-50/50');
                            }
                        }
                        
                        // 對經緯度數據使用等寬字體並靠右對齊 (第 1, 2 欄是經緯度)
                        if (colIndex === 1 || colIndex === 2) {
                            cell.classList.add('font-mono', 'text-right', 'coordinate-cell'); 
                        }
                        
                        // 對角度數據使用等寬字體並靠右對齊 (從第 5 欄到第 10 欄是角度數據)
                        if (colIndex >= 5 && colIndex <= 10 && typeof value === 'string' && value.includes('.') && value.length > 5) {
                             cell.classList.add('font-mono', 'text-right');
                        }
                        
                         // 對未匹配的點位
                        if (point.matchCount === 0) {
                            if (colIndex === 4) { // 狀態欄位
                                cell.classList.remove('text-gray-700');
                                cell.classList.add('text-red-700', 'italic', 'font-bold');
                            } else if (colIndex > 4) { // 元數據欄位，清空內容並變灰
                                cell.textContent = '-';
                                cell.classList.add('text-gray-400', 'italic');
                            }
                        }
                         // 針對 ID 列表欄位，強制換行顯示
                        if (colIndex === 4) {
                            cell.style.whiteSpace = 'normal'; // 允許自動換行
                            cell.style.maxWidth = '250px';
                        }
                    });
                });
            } else {
                matchedPointsWrapper.classList.add('hidden');
            }
        }


        // 步驟 3: CSV 下載邏輯
        downloadButton.addEventListener('click', downloadCSV);

        function downloadCSV() {
            if (metadataCollection.length === 0 && matchedPoints.length === 0) {
                showMessage('表格中沒有數據可以下載。', 'error');
                return;
            }

            let csv = '';

            // 1. 影像元數據區塊 (不變)
            if (metadataCollection.length > 0) {
                csv += "### 影像元數據清單 ###\n";
                csv += METADATA_HEADERS.join(',') + '\n';

                metadataCollection.forEach((data, index) => {
                    const rowData = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        `"${data.ACQU_DATE}"`, 
                        formatAngle(data.Incidence_Angle),
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ].join(',');
                    csv += rowData + '\n';
                });
                csv += '\n'; 
            }


            // 2. 點位匹配結果區塊 (使用分組後的數據)
            if (matchedPoints.length > 0) {
                csv += "### 點位匹配結果 (元數據相同的影像已合併為一行) ###\n";
                
                // 匯出標頭
                const pointMatchCsvHeaders = [
                    '點位序號', '輸入經度 (y)', '輸入緯度 (x)', '輸入日期 (d)', 
                    '匹配的 Images_ID_List', '匹配數量 (Match Count)', 
                    'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
                    'Sun Azimuth', 'Sun Elevation', 'Orientation', 
                    'SATELLITE', 'SENSOR' // 新增的欄位
                ];
                csv += pointMatchCsvHeaders.join(',') + '\n';

                matchedPoints.forEach(point => {
                    // 匯出時使用分號 (;) 區隔 ID，避免逗號與 CSV 欄位分隔符號衝突
                    const imageIdList = point.matchCount === 0 ? '' : point.imageIds.join(';'); 
                    const matchCount = point.matchCount || 0;

                    const rowData = [
                        point.index,
                        point.lng, 
                        point.lat, 
                        formatDateDisplay(point.date), 
                        `"${imageIdList}"`, // 輸出 ID 列表 (用引號包圍，確保分號不會被誤判)
                        matchCount,
                        // 匹配到的元數據
                        formatAngle(point.Incidence_Angle),
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation),
                        point.SATELLITE || '-', // 匯出衛星/感測器名稱
                        point.SENSOR || '-'
                    ].join(',');
                    csv += rowData + '\n';
                });
            }


            // 創建 Blob 並觸發下載 (使用 \ufeff 確保中文編碼正確)
            const blob = new Blob(["\ufeff", csv], { type: 'text/csv;charset=utf-8;' }); 
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            
            link.setAttribute("href", url);
            link.setAttribute("download", `影像元數據與點位匹配結果_${new Date().toISOString().slice(0, 10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);

            showMessage('試算表下載完成！', 'success');
        }


        // 步驟 3: 複製表格數據到剪貼簿 (使用 Tab 分隔)
        copyButton.addEventListener('click', copyTableToClipboard);

        function copyTableToClipboard() {
            if (metadataCollection.length === 0 && matchedPoints.length === 0) {
                showMessage('表格中沒有數據可以複製。', 'error');
                return;
            }

            let tsv = '';

            // 1. 影像元數據區塊 (不變)
            if (metadataCollection.length > 0) {
                tsv += "### 影像元數據清單 ###\n";
                tsv += METADATA_HEADERS.join('\t') + '\n';

                metadataCollection.forEach((data, index) => {
                    const rowData = [
                        index + 1, 
                        data.IMAGE_ID,
                        data.SATELLITE,
                        data.SENSOR,
                        (data.ACQU_DATE || '-').replace(/\t/g, ' ').replace(/\n/g, ' '), 
                        formatAngle(data.Incidence_Angle),
                        formatAngle(data.View_Angle_Along),
                        formatAngle(data.View_Angle_Cross),
                        formatAngle(data.Sun_Azimuth),
                        formatAngle(data.Sun_Elevation),
                        formatAngle(data.Orientation),
                        formatCoordinate(data.UL_LAT),
                        formatCoordinate(data.UR_LAT),
                        formatCoordinate(data.LL_LAT),
                        formatCoordinate(data.LR_LAT),
                        formatCoordinate(data.UL_LNG),
                        formatCoordinate(data.UR_LNG),
                        formatCoordinate(data.LL_LNG),
                        formatCoordinate(data.LR_LNG),
                    ].join('\t');
                    tsv += rowData + '\n';
                });
                tsv += '\n'; 
            }

            // 2. 點位匹配結果區塊 (使用分組後的數據)
            if (matchedPoints.length > 0) {
                tsv += "### 點位匹配結果 (元數據相同的影像已合併為一行) ###\n";
                
                const pointMatchCsvHeaders = [
                    '點位序號', '輸入經度 (y)', '輸入緯度 (x)', '輸入日期 (d)', 
                    '匹配的 Images_ID_List', '匹配數量 (Match Count)', 
                    'Incidence Angle', 'View Angle(Along)', 'View Angle(Cross)', 
                    'Sun Azimuth', 'Sun Elevation', 'Orientation',
                    'SATELLITE', 'SENSOR' // 新增的欄位
                ];
                tsv += pointMatchCsvHeaders.join('\t') + '\n';

                matchedPoints.forEach(point => {
                    // 匯出時使用分號 (;) 區隔 ID，這是 Excel 貼上時最不容易出錯的分隔方式
                    const imageIdList = point.matchCount === 0 ? '' : point.imageIds.join(';'); 
                    const matchCount = point.matchCount || 0;

                    const rowData = [
                        point.index,
                        point.lng, 
                        point.lat, 
                        formatDateDisplay(point.date), 
                        imageIdList, // TSV 中直接輸出 ID 列表
                        matchCount,
                        // 匹配到的元數據
                        formatAngle(point.Incidence_Angle),
                        formatAngle(point.View_Angle_Along),
                        formatAngle(point.View_Angle_Cross),
                        formatAngle(point.Sun_Azimuth),
                        formatAngle(point.Sun_Elevation),
                        formatAngle(point.Orientation),
                        point.SATELLITE || '-',
                        point.SENSOR || '-'
                    ].join('\t');
                    tsv += rowData + '\n';
                });
            }


            const tempTextArea = document.createElement('textarea');
            tempTextArea.value = tsv;
            document.body.appendChild(tempTextArea);
            tempTextArea.select();

            try {
                const successful = document.execCommand('copy');
                if (successful) {
                    showMessage('表格數據已成功複製到剪貼簿！請切換到 Excel 貼上 (Ctrl+V)。', 'success');
                } else {
                    showMessage('複製失敗，請檢查瀏覽器權限或手動複製。', 'error');
                }
            } catch (err) {
                console.error('執行複製命令失敗:', err);
                showMessage('複製失敗，請檢查瀏覽器權限或手動複製。', 'error');
            }
            
            document.body.removeChild(tempTextArea);
        }

        // 初始化時渲染空表格
        renderTables();

    </script>
</body>
</html>
